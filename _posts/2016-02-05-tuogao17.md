---
layout: post
title: "Swift2.0ä¹‹CoreTextæ’ç‰ˆç¥å™¨(ç»­)"
description: "CoreText"
category: æŠ•ç¨¿
headline: Discover the theme elements
tags: [Swift2.0ï¼ŒCoreTextï¼Œæ’ç‰ˆï¼ŒiOSå¼€å‘]
imagefeature: BG2.jpg
comments: true
featured: true
mathjax: true
path: /images
---
ç¼–è¾‘ï¼š[Bison](http://allluckly.cn/)<br>
æŠ•ç¨¿ï¼š[å¤§çŸ³å¤´å¸ƒ](http://www.jianshu.com/p/e52a38e60e7c)<br>

>&quot;æœ¬ç¯‡æ˜¯ç»­ä¸Šç¯‡ [Swift2.0ä¹‹CoreTextæ’ç‰ˆç¥å™¨é•¿ç¯‡é«˜èƒ½)](http://allluckly.cn/æŠ•ç¨¿/tuogao14/) ï¼Œæ²¡çœ‹ä¸Šç¯‡åŸºç¡€ç¯‡çš„å»ºè®®ä»ä¸Šç¯‡çœ‹èµ·.:&quot;

<br>

ä¸Šç¯‡æˆ‘ä»¬ä»‹ç»äº†NSAttributeStringå±æ€§å­—å’ŒCoreTextçš„ç®€å•ä½¿ç”¨ï¼Œä»¥åŠç®€å•çš„å›¾æ–‡æ··æ’ã€‚è¿™èŠ‚æˆ‘ä»¬ä½¿ç”¨CoreTextæ¥è§£å†³äº›å…¶ä»–é—®é¢˜ã€‚<br>


å…ˆæ¥çœ‹ä¸€å‰¯å›¾<br>

![1]({{ page.path }}/blog/tuogao/tougao17/1.jpg)<br>

å¦‚å›¾ï¼ŒOriginé‚£å—æ˜¯åŸºçº¿ç›¸å½“äºåŸç‚¹ï¼Œdescentæ˜¯å‘ä¸‹çš„ ä¸€èˆ¬æ˜¯è´Ÿå€¼ï¼Œascentæ˜¯æ­£å€¼ï¼Œè¿˜æœ‰lineHeightå’ŒcapHeightè¿˜æœ‰x-heightéƒ½åœ¨å›¾ä¸­æ ‡å‡ºï¼Œé‚£åœ¨ä»£ç ä¸­å¦‚ä½•è·å–è¿™äº›å€¼å‘¢ï¼Ÿ<br>


    let font = UIFont.systemFontOfSize(14)
    print(font.descender)       //-3.376953125
    print(font.ascender)        //13.330078125
    print(font.lineHeight)      //16.70703125
    print(font.capHeight)       //9.8642578125
    print(font.xHeight)         //7.369140625
    print(font.leading)         //0.0

<br>
è¿™é‡Œå®šä¹‰ä¸€ä¸ª14å·çš„æ–‡å­— å–å‡ºå¯¹åº”çš„å„ä¸ªå€¼ã€‚è¿™äº›éƒ½æ˜¯åªè¯»çš„<br>

çº¯æ–‡æœ¬æ’ç‰ˆçš„æ—¶å€™ä¼šæœ‰ä¸€äº›ç»†èŠ‚é—®é¢˜ï¼Œæˆ‘ä»¬å…ˆæ¥ç»˜åˆ¶ä¸€ä¸ªå¸¦æœ‰ä¸­æ–‡ï¼Œè‹±æ–‡ï¼Œæ•°å­—ä»¥åŠemojiè¡¨æƒ…çš„æ–‡æœ¬çœ‹çœ‹æ•ˆæœã€‚<br>


æœªå¤„ç†å‰çš„ç»˜åˆ¶<br>

![1]({{ page.path }}/blog/tuogao/tougao17/2.png)<br>

å¯ä»¥çœ‹å‡ºåœ¨å«æœ‰emojiçš„é‚£å‡ è¡Œå æœ‰çš„é«˜åº¦ä¼šæ¯”è¾ƒé«˜ï¼Œç©ºéš™æ¯”è¾ƒå¤§ã€‚æ‰€ä»¥å¦‚æœæŒ‰boundingRectWithSize æ ¹æ®å­—ä½“å¤§å°å’Œå®½åº¦æ¥è®¡ç®—æ–‡æœ¬é«˜åº¦çš„æ–¹æ³•å°±ä¸è¡Œäº†ï¼Œè€Œä¸”è¿™æ ·æ’ç‰ˆçœ‹èµ·æ¥ä¹Ÿä¸æ˜¯å¾ˆç¾è§‚ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸èƒ½ç›´æ¥ç”¨CTFrameDrawæ¥ç»˜åˆ¶äº†ï¼Œå¯èƒ½éœ€è¦ç»™å®šè¡Œé«˜ï¼Œä¸€è¡Œä¸€è¡Œç»˜åˆ¶ ï¼Œä½¿ç”¨CTLineDraw ã€‚<br>

é¦–å…ˆæˆ‘ä»¬éœ€è¦è®¡ç®—å‡ºæ–‡å­—æ‰€å çš„Size.<br>

    let SCREEN_WIDTH:CGFloat = UIScreen.mainScreen().bounds.size.width  //å±å¹•å®½åº¦
    /**
    è®¡ç®—Size

    - parameter txt: æ–‡æœ¬

    - returns: size
    */
    func sizeForText(mutableAttrStr:NSMutableAttributedString)->CGSize{
        //åˆ›å»ºCTFramesetterRefå®ä¾‹
        let frameSetter = CTFramesetterCreateWithAttributedString(mutableAttrStr)

        // è·å¾—è¦ç»˜åˆ¶åŒºåŸŸçš„é«˜åº¦
        let restrictSize = CGSizeMake(SCREEN_WIDTH-20, CGFloat.max)
        let coreTextSize = CTFramesetterSuggestFrameSizeWithConstraints(frameSetter, CFRangeMake(0, 0) , nil, restrictSize, nil)
        return coreTextSize
    }
<br>

å¾ˆç®€å• ï¼Œæ ¹æ®å±æ€§å­—å¾—åˆ°framesetter ç„¶åå†æ ¹æ®framesetterè®¡ç®—å‡ºæ‰€å çš„sizeã€‚<br>

å¾—åˆ°sizeåè¦æ€ä¹ˆæ“ä½œå‘¢?<br>

è¿™å—æˆ‘è´´ä¸‹æ‰€æœ‰ä»£ç  æ³¨é‡Šå¾ˆè¯¦ç»†<br>

    import UIKit

    class CTextView: UIView {

        let SCREEN_WIDTH:CGFloat = UIScreen.mainScreen().bounds.size.width  //å±å¹•å®½åº¦
        let SCREEN_HEIGHT:CGFloat = UIScreen.mainScreen().bounds.size.height    //å±å¹•é«˜åº¦

        override func drawRect(rect: CGRect) {
            super.drawRect(rect)

            // 1 è·å–ä¸Šä¸‹æ–‡
            let context = UIGraphicsGetCurrentContext()

            // 2 è½¬æ¢åæ ‡
            CGContextSetTextMatrix(context, CGAffineTransformIdentity)
            CGContextTranslateCTM(context, 0, self.bounds.size.height)
            CGContextScaleCTM(context, 1.0, -1.0)

            // 3 ç»˜åˆ¶åŒºåŸŸ
            let path = UIBezierPath(rect: rect)

            // 4 åˆ›å»ºéœ€è¦ç»˜åˆ¶çš„æ–‡å­—
            let attrString = "æ¥ä¸€æ®µæ•°å­—,æ–‡æœ¬emojiçš„å“ˆå“ˆå“ˆ29993002-309-sdflslsflæ˜¯ç”µè¯è´¹å¡åˆ·å¡æ¥è¿™æ¥ä¸€æ®µæ•°å­—,æ–‡æœ¬emojiçš„å“ˆå“ˆå“ˆ29993002-309-sdflslsflæ˜¯ç”µè¯è´¹å¡åˆ·å¡æ¥è¿™æ¥ä¸€æ®µæ•°å­—,æ–‡æœ¬emojiçš„å“ˆå“ˆå“ˆ29993002-309-sdflslsflæ˜¯ç”µè¯è´¹å¡åˆ·å¡æ¥è¿™æ¥ä¸€æ®µæ•°å­—,æ–‡æœ¬emojiçš„å“ˆå“ˆå“ˆ29993002-309-å…°emojiğŸ‘¿ğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜Šæ°´ç”µè´¹æ´›æ‰çŸ¶å¤§ç«‹ç§‘æŠ€ğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜Šç´¢æ‹‰å¡å«æˆ‘ğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜Šsljwolw19287812æ¥ä¸€æ®µæ•°å­—,æ–‡æœ¬emojiçš„å“ˆå“ˆå“ˆ29993002-309-sdflslsflæ˜¯ç”µè¯è´¹å¡åˆ·å¡æ¥è¿™æ¥ä¸€æ®µæ•°å­—,æ–‡æœ¬emojiçš„å“ˆå“ˆå“ˆ29993002-309-sdflslsflæ˜¯ç”µè¯è´¹å¡åˆ·å¡æ¥è¿™æ¥ä¸€æ®µæ•°å­—,æ–‡æœ¬emojiçš„å“ˆå“ˆå“ˆ29993002-309-sdflslsflæ˜¯ç”µè¯è´¹å¡åˆ·å¡æ¥è¿™æ¥ä¸€æ®µæ•°å­—,æ–‡æœ¬emojiçš„å“ˆå“ˆå“ˆ29993002-309-sdflslsflæ˜¯ç”µè¯è´¹å¡åˆ·å¡æ¥è¿™"

            // 5 è®¾ç½®frame
            let mutableAttrStr = NSMutableAttributedString(string: attrString)
            let framesetter = CTFramesetterCreateWithAttributedString(mutableAttrStr)
            let frame = CTFramesetterCreateFrame(framesetter, CFRangeMake(0, mutableAttrStr.length), path.CGPath, nil)

            // 6 å–å‡ºCTLine å‡†å¤‡ä¸€è¡Œä¸€è¡Œç»˜åˆ¶
            let lines = CTFrameGetLines(frame)
            let lineCount = CFArrayGetCount(lines)


            var lineOrigins:[CGPoint] = Array(count:lineCount,repeatedValue:CGPointZero)

            //æŠŠframeé‡Œæ¯ä¸€è¡Œçš„åˆå§‹åæ ‡å†™åˆ°æ•°ç»„é‡Œï¼Œæ³¨æ„CoreTextçš„åæ ‡æ˜¯å·¦ä¸‹è§’ä¸ºåŸç‚¹
            CTFrameGetLineOrigins(frame, CFRangeMake(0, 0),&lineOrigins)
            //è·å–å±æ€§å­—æ‰€å çš„size
            let size = sizeForText(mutableAttrStr)
            let height = size.height

            let font = UIFont.systemFontOfSize(14)
            var frameY:CGFloat = 0
            // è®¡ç®—æ¯è¡Œçš„é«˜åº¦ (æ€»é«˜åº¦é™¤ä»¥è¡Œæ•°)
            let lineHeight = height/CGFloat(lineCount)
            for i in 0..<lineCount{

                let lineRef = unsafeBitCast(CFArrayGetValueAtIndex(lines,i), CTLineRef.self)

                var lineAscent:CGFloat = 0
                var lineDescent:CGFloat = 0
                var leading:CGFloat = 0
                //è¯¥å‡½æ•°é™¤äº†ä¼šè®¾ç½®å¥½ascent,descent,leadingä¹‹å¤–ï¼Œè¿˜ä¼šè¿”å›è¿™è¡Œçš„å®½åº¦
                CTLineGetTypographicBounds(lineRef, &lineAscent, &lineDescent, &leading)

                var lineOrigin = lineOrigins[i]

                //è®¡ç®—yå€¼(æ³¨æ„å·¦ä¸‹è§’æ˜¯åŸç‚¹)
                frameY = height - CGFloat(i + 1)*lineHeight - font.descender
                //è®¾ç½®Yå€¼
                lineOrigin.y = frameY

                //ç»˜åˆ¶
                CGContextSetTextPosition(context,lineOrigin.x, lineOrigin.y)
                CTLineDraw(lineRef, context!)

                //è°ƒæ•´åæ ‡
                frameY = frameY - lineDescent
            }
            //
            //        CTFrameDraw(frame,context!)
        }

        /**
        è®¡ç®—Size

        - parameter txt: æ–‡æœ¬

        - returns: size
        */
        func sizeForText(mutableAttrStr:NSMutableAttributedString)->CGSize{
            //åˆ›å»ºCTFramesetterRefå®ä¾‹
            let frameSetter = CTFramesetterCreateWithAttributedString(mutableAttrStr)

            // è·å¾—è¦ç»˜åˆ¶åŒºåŸŸçš„é«˜åº¦
            let restrictSize = CGSizeMake(SCREEN_WIDTH-20, CGFloat.max)
            let coreTextSize = CTFramesetterSuggestFrameSizeWithConstraints(frameSetter, CFRangeMake(0, 0) , nil, restrictSize, nil)
            return coreTextSize
            }

    }


<br>

å‰é¢5æ­¥å’Œå‰ä¸€ä¸ªå°ç»“æ˜¯ä¸€æ ·çš„ï¼Œè¿™æ¬¡æ‹¿åˆ°CTFrameåæˆ‘ä»¬å¹¶æ²¡æœ‰ç›´æ¥è°ƒç”¨CTFrameDraw æ¥ç»˜åˆ¶ã€‚è€Œæ˜¯è·å–æ‰€æœ‰çš„CTLineï¼Œæ‹¿åˆ°CTLineåå†è®¡ç®—æ€»é«˜åº¦ã€‚æ ¹æ®æ€»é«˜åº¦è®¡ç®—æ¯è¡Œé«˜åº¦ï¼Œç„¶åå¾ªç¯CTLineï¼Œè·å–æ¯ä¸ªLineè®¡ç®—YæŒ‡æ ‡çš„å€¼ï¼Œé€è¡Œè®¾ç½®ä½ç½®ç„¶åDrawä¸Šå»ã€‚<br>

    CGContextSetTextPosition(context,lineOrigin.x, lineOrigin.y) 
    CTLineDraw(lineRef, context!)

<br>
çœ‹ä¸‹å¯¹æ¯”æ•ˆæœ<br>

![1]({{ page.path }}/blog/tuogao/tougao17/3.png)<br>

å·¦è¾¹æ˜¯ç›´æ¥ç”»çš„ï¼Œå³è¾¹æ˜¯é€è¡Œè®¡ç®—åç”»çš„ï¼Œç­‰é«˜äº†ï¼Œçœ‹èµ·æ¥ä¸ä¼šæœ‰å±‚æ¬¡ä¸é½çš„æ„Ÿè§‰äº†ï¼<br>

ä¸‹é¢çœ‹çœ‹æ€ä¹ˆè‡ªåŠ¨è¯†åˆ«è¿æ¥ç­‰<br>

> å®ç°çš„æ€è·¯ä¸»è¦æ˜¯ç»™æ§ä»¶æ·»åŠ æ‰‹åŠ¿ç‚¹å‡»å¹¶è¿›è¡Œç›‘å¬ï¼Œåœ¨ç”¨æˆ·ç‚¹å‡»æ—¶æ‹¿åˆ°ç‚¹å‡»çš„ä½ç½®ï¼Œå¹¶åœ¨æ‰‹åŠ¿è¯†åˆ«ç»“æŸåç”¨CoreTextéå†æ¯ä¸€ä¸ªCTLineï¼Œåˆ¤æ–­ç‚¹å‡»çš„ä½ç½®æ˜¯å¦åœ¨è¯†åˆ«çš„ç‰¹å®šå­—ç¬¦ä¸²å†…ï¼Œå¦‚æœæ˜¯åˆ™æ‰¾å‡ºè¯¥å­—ç¬¦ä¸²ã€‚ä½¿CTLineGetStringIndexForPositionå‡½æ•°æ¥æ‰¾å‡ºç‚¹å‡»çš„å­—ç¬¦ä½äºæ•´ä¸ªå­—ç¬¦ä¸²çš„ä½ç½®ã€‚<br>

é¦–å…ˆå†™ä¸¤ä¸ªæ­£åˆ™æ¥æ£€æµ‹æ–‡æœ¬ä¸­çš„@å’Œé“¾æ¥ï¼Œ å¦‚æœæ‚¨æœ‰ä»»ä½•éœ€è¦æ£€æµ‹çš„éƒ½å¯ä»¥æ·»åŠ æ­£åˆ™å»å®ç°ã€‚<br>

    //urlçš„æ­£åˆ™
    let regex_url = "(http|ftp|https):\\/\\/[\\w\\-_]+(\\.[\\w\\-_]+)+([\\w\\-\\.,@?^=%&:/~\\+#]*[\\w\\-\\@?^=%&/~\\+#])?"

    let regex_someone = "@[^\\s@]+?\\s{1}"

<br>
å…³äºæ­£åˆ™è¡¨è¾¾å¼ï¼Œä¸å†æœ¬æ–‡è®¨è®ºèŒƒå›´å†…ï¼Œè‡ªè¡Œgoogle....<br>

ç„¶åå°±è¦æ ¹æ®æ­£åˆ™åŒ¹é…å­—ç¬¦ä¸²ã€‚è¿”å›å¯¹åº”çš„rangeå¹¶ä¸”ä¿®æ”¹å±æ€§å­—çš„é¢œè‰²ã€‚<br>

    //è¯†åˆ«ç‰¹å®šå­—ç¬¦ä¸²å¹¶æ”¹å…¶é¢œè‰²ï¼Œè¿”å›è¯†åˆ«åˆ°çš„å­—ç¬¦ä¸²æ‰€åœ¨çš„range
    func recognizeSpecialStringWithAttributed(attrStr:NSMutableAttributedString)->[NSRange]{
        // 1
        var rangeArray = [NSRange]()
        //è¯†åˆ«äººåå­—
        // 2
        let atRegular = try? NSRegularExpression(pattern: regex_someone, options: NSRegularExpressionOptions.CaseInsensitive) //ä¸åŒºåˆ†å¤§å°å†™çš„
        // 3
        let atResults = atRegular?.matchesInString(attrStr.string, options: NSMatchingOptions.WithTransparentBounds , range: NSMakeRange(0, attrStr.length))
        // 4
        for checkResult in atResults!{
            attrStr.addAttribute(NSForegroundColorAttributeName, value: UIColor.redColor(), range: NSMakeRange(checkResult.range.location, checkResult.range.length))
            rangeArray.append(checkResult.range)
        }


        //è¯†åˆ«é“¾æ¥
        let atRegular1 = try? NSRegularExpression(pattern: regex_url, options: NSRegularExpressionOptions.CaseInsensitive) //ä¸åŒºåˆ†å¤§å°å†™çš„
        let atResults1 = atRegular1?.matchesInString(attrStr.string, options: NSMatchingOptions.WithTransparentBounds , range: NSMakeRange(0, attrStr.length))

        for checkResult in atResults1!{
            attrStr.addAttribute(NSForegroundColorAttributeName, value: UIColor.blueColor(), range: NSMakeRange(checkResult.range.location, checkResult.range.length))
            rangeArray.append(checkResult.range)
        }


        return rangeArray
    }

<br>
æˆ‘è¿™é‡Œå°±è¯†åˆ«äº†@å’Œé“¾æ¥ï¼Œå¤§å®¶è‡ªè¡Œæ·»åŠ ï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿å¹¶æ²¡æœ‰å°è£…ï¼Œå¤§å®¶å¯ä»¥å°è£…ä¸‹ï¼Œä½¿ç”¨ä¸€ä¸ªç»“æ„ä½“ï¼Œæœ‰NSRange æ•°ç»„ å’Œtypeç±»å‹ æˆ–è€…å­—å…¸ç±»å‹ï¼Œè‡ªç”±å‘æŒ¥ã€‚è¿™é‡Œåªåšè¯†åˆ«ã€‚ç¨å¾®è§£é‡Šä¸‹ä»£ç <br>

1ã€å®šä¹‰ä¸€ä¸ªæ•°ç»„å­˜æ”¾åŒ¹é…çš„Rangeé›†åˆ<br>

2ã€æ ¹æ®å‰é¢å®šä¹‰çš„æ­£åˆ™åˆ›å»ºä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡ï¼Œè¿™é‡Œä¼šæŠ›å‡ºå¼‚å¸¸ä¸ºäº†æ–¹ä¾¿ï¼Œå¹¶æ²¡æœ‰å¤„ç†ã€‚optionè¿™é‡Œä½¿ç”¨äº†CaseInsensitiveä¸åŒºåˆ†å¤§å°å†™ã€‚è¿˜æœ‰å¾ˆå¤šåˆ«çš„é€‰é¡¹ã€‚ç›´æ¥command+ç‚¹å‡»çœ‹ã€‚<br>

3ã€æ‹¿åˆ°åŒ¹é…çš„ç»“æœé›†ï¼ŒåŒ…å«rangeå±æ€§(æˆ‘ä»¬éœ€è¦çš„)<br>

4ã€å¾ªç¯æ·»åŠ åˆ°æ•°ç»„ï¼Œå¹¶ç»™è¿™ä¸ªrangeçš„å­—ç¬¦ä¿®æ”¹é¢œè‰²å±æ€§ã€‚<br>

è§£ææ–¹æ³•å‡†å¤‡å¥½ä¹‹åå°±å¯ä»¥å¼€å§‹ç»˜åˆ¶äº†ï¼Œå’Œå‰é¢çš„å¤§åŒå°å¼‚<br>

    let SCREEN_WIDTH:CGFloat = UIScreen.mainScreen().bounds.size.width  //å±å¹•å®½åº¦
    let SCREEN_HEIGHT:CGFloat = UIScreen.mainScreen().bounds.size.height    //å±å¹•é«˜åº¦


    var lineHeight:CGFloat = 0
    var ctFrame:CTFrameRef?

    var spcialRanges = [NSRange]()

    //urlçš„æ­£åˆ™
    let regex_url = "(http|ftp|https):\\/\\/[\\w\\-_]+(\\.[\\w\\-_]+)+([\\w\\-\\.,@?^=%&:/~\\+#]*[\\w\\-\\@?^=%&/~\\+#])?"

    let regex_someone = "@[^\\s@]+?\\s{1}"

    let str = "æ¥ä¸€æ®µæ•° @sdåœ£è¯èŠ‚ å­—,æ–‡æœ¬emojiçš„å“ˆå“ˆå“ˆ29993002-309-sdflslsflæ˜¯ç”µè¯è´¹å¡åˆ·å¡æ¥è¿™æ¥ä¸€æ®µæ•°å­—,æ–‡æœ¬emojiçš„å“ˆå“ˆå“ˆ29993002-309-sdflslsfl http://www.baidu.com æ˜¯ç”µè¯è´¹å¡åˆ·å¡æ¥è¿™æ¥ä¸€æ®µæ•°å­—,æ–‡æœ¬emoji http://www.zuber.im çš„å“ˆå“ˆå“ˆ29993002-309-sdflslsflæ˜¯ç”µè¯è´¹å¡ @kakakkak åˆ·å¡æ¥è¿™æ¥ä¸€æ®µæ•°å­—,æ–‡æœ¬emojiçš„å“ˆå“ˆå“ˆ29993002-309-å…°emojiğŸ‘¿ğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜Šæ°´ç”µè´¹æ´›æ‰çŸ¶å¤§ç«‹ç§‘æŠ€ğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜Šç´¢æ‹‰å¡å«æˆ‘ğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜Šsljwolw19287812æ¥ä¸€æ®µæ•°å­—,æ–‡æœ¬emojiçš„å“ˆå“ˆå“ˆ29993002-309-sdflslsflæ˜¯ç”µè¯è´¹å¡åˆ·å¡æ¥è¿™æ¥ä¸€æ®µæ•°å­—,æ–‡æœ¬emojiçš„å“ˆå“ˆå“ˆ29993002-309-sdflslsflæ˜¯ç”µè¯è´¹å¡åˆ·å¡æ¥è¿™æ¥ä¸€æ®µæ•°å­—,æ–‡æœ¬emojiçš„å“ˆå“ˆå“ˆ29993002-309-sdflslsflæ˜¯ç”µè¯è´¹å¡åˆ·å¡æ¥è¿™æ¥ä¸€æ®µæ•°å­—,æ–‡æœ¬emojiçš„å“ˆå“ˆå“ˆ29993002-309-sdflslsflæ˜¯ç”µè¯è´¹å¡åˆ·å¡æ¥è¿™"
    var pressRange:NSRange?
    var mutableAttrStr:NSMutableArray!
    var selfHeight:CGFloat = 0

    override func drawRect(rect: CGRect) {
        super.drawRect(rect)
        // 1 è·å–ä¸Šä¸‹æ–‡
        let context = UIGraphicsGetCurrentContext()

        // 2 è½¬æ¢åæ ‡
        CGContextSetTextMatrix(context, CGAffineTransformIdentity)
        CGContextTranslateCTM(context, 0, self.bounds.size.height)
        CGContextScaleCTM(context, 1.0, -1.0)

        // 3 ç»˜åˆ¶åŒºåŸŸ
        let path = UIBezierPath(rect: rect)

        // 4 åˆ›å»ºéœ€è¦ç»˜åˆ¶çš„æ–‡å­—


        // 5 è®¾ç½®frame
        let mutableAttrStr = NSMutableAttributedString(string: str)
        // è·å–ç‰¹æ®Šå­—ç¬¦range ç»˜åˆ¶ç‰¹æ®Šå­—ç¬¦
        self.spcialRanges = recognizeSpecialStringWithAttributed(mutableAttrStr)

        let framesetter = CTFramesetterCreateWithAttributedString(mutableAttrStr)
        ctFrame = CTFramesetterCreateFrame(framesetter, CFRangeMake(0, mutableAttrStr.length), path.CGPath, nil)

        // 6 å–å‡ºCTLine å‡†å¤‡ä¸€è¡Œä¸€è¡Œç»˜åˆ¶
        let lines = CTFrameGetLines(ctFrame!)
        let lineCount = CFArrayGetCount(lines)


        var lineOrigins:[CGPoint] = Array(count:lineCount,repeatedValue:CGPointZero)

        //æŠŠframeé‡Œæ¯ä¸€è¡Œçš„åˆå§‹åæ ‡å†™åˆ°æ•°ç»„é‡Œï¼Œæ³¨æ„CoreTextçš„åæ ‡æ˜¯å·¦ä¸‹è§’ä¸ºåŸç‚¹
        CTFrameGetLineOrigins(ctFrame!, CFRangeMake(0, 0),&lineOrigins)
        //è·å–å±æ€§å­—æ‰€å çš„size
        let size = sizeForText(mutableAttrStr)
        let height = size.height
        //        self.frame.size.height = height

        let font = UIFont.systemFontOfSize(14)
        var frameY:CGFloat = 0
        // è®¡ç®—æ¯è¡Œçš„é«˜åº¦ (æ€»é«˜åº¦é™¤ä»¥è¡Œæ•°)
        lineHeight = height/CGFloat(lineCount)
        for i in 0..<lineCount{

            let lineRef = unsafeBitCast(CFArrayGetValueAtIndex(lines,i), CTLineRef.self)

            var lineAscent:CGFloat = 0
            var lineDescent:CGFloat = 0
            var leading:CGFloat = 0
            //è¯¥å‡½æ•°é™¤äº†ä¼šè®¾ç½®å¥½ascent,descent,leadingä¹‹å¤–ï¼Œè¿˜ä¼šè¿”å›è¿™è¡Œçš„å®½åº¦
            CTLineGetTypographicBounds(lineRef, &lineAscent, &lineDescent, &leading)

            var lineOrigin = lineOrigins[i]

            //è®¡ç®—yå€¼(æ³¨æ„å·¦ä¸‹è§’æ˜¯åŸç‚¹)
            frameY = height - CGFloat(i + 1)*lineHeight - font.descender
            //è®¾ç½®Yå€¼
            lineOrigin.y = frameY

            //ç»˜åˆ¶
            CGContextSetTextPosition(context,lineOrigin.x, lineOrigin.y)
            CTLineDraw(lineRef, context!)

            //è°ƒæ•´åæ ‡
            frameY = frameY - lineDescent
        }
    }

<br>
è¿™æ®µä»£ç å’Œä¹‹å‰å·®ä¸å¤šï¼Œåªä¸è¿‡æŠŠä¸€äº›å˜é‡æ”¾åœ¨å¤–é¢å®šä¹‰ä»¥ä¾¿åˆ«çš„æ–¹æ³•ä½¿ç”¨ã€‚è¿˜æœ‰å°±æ˜¯åŠ ä¸Šäº†é‚£ä¸ªè§£æçš„æ–¹æ³•<br>

    self.spcialRanges = recognizeSpecialStringWithAttributed(mutableAttrStr)

<br>
åœ¨ViewControllerä¸­è°ƒç”¨<br>

    let ctURLView = CTURLView()
    ctURLView.frame = CGRectMake(10, 100, self.view.bounds.width - 20, 300)
    ctURLView.backgroundColor = UIColor.grayColor()
    let mutableAttrStr = NSMutableAttributedString(string: ctURLView.str)
    let size = ctURLView.sizeForText(mutableAttrStr)
    ctURLView.frame.size = size
    self.view.addSubview(ctURLView)

<br>
è¿™è¾¹è¦å…ˆè®¡ç®—ä¸‹size<br>

çœ‹ä¸‹æ•ˆæœ<br>
![1]({{ page.path }}/blog/tuogao/tougao17/4.png)<br>

ä¸é”™å§ å¹¶æ²¡æœ‰å¤šå°‘ä»£ç å°±è¯†åˆ«å‡ºæ¥äº†ï¼Œä¸‹é¢çœ‹çœ‹å¤„ç†ç‚¹å‡»äº‹ä»¶<br>

é¦–å…ˆæ³¨å†Œä¸€ä¸ªtapæ‰‹åŠ¿å¹¶è®¾ç½®ä¸‹ä»£ç†<br>

    override init(frame: CGRect) {
        super.init(frame: frame)
        //æ·»åŠ æ‰‹åŠ¿
        let tap = UITapGestureRecognizer(target: self, action: "tap:")
        tap.delegate = self
        self.addGestureRecognizer(tap)
    }

<br>

ç„¶åå®ç°æ‰‹åŠ¿æ–¹æ³•å’Œä»£ç†<br>

    extension CTURLView:UIGestureRecognizerDelegate{

        func tap(gesture:UITapGestureRecognizer){

            if gesture.state == .Ended{
                let nStr = self.str as NSString
                let pressStr = nStr.substringWithRange(self.pressRange!)
                print(pressStr)
            }
        }

        override func gestureRecognizerShouldBegin(gestureRecognizer: UIGestureRecognizer) -> Bool {
            //ç‚¹å‡»å¤„åœ¨ç‰¹å®šå­—ç¬¦ä¸²å†…æ‰è¿›è¡Œè¯†åˆ«
            var gestureShouldBegin = false
            // 1
            let location = gestureRecognizer.locationInView(self)

            // 2
            let lineIndex = Int(location.y/lineHeight)

            print("ä½ ç‚¹å‡»äº†ç¬¬\(lineIndex)è¡Œ")

            // 3 æŠŠç‚¹å‡»çš„åæ ‡è½¬æ¢ä¸ºCoreTextåæ ‡ç³»ä¸‹
            let clickPoint = CGPointMake(location.x, lineHeight-location.y)

            let lines = CTFrameGetLines(self.ctFrame!);
            let lineCount = CFArrayGetCount(lines)
            if lineIndex < lineCount{

            let clickLine =  unsafeBitCast(CFArrayGetValueAtIndex(lines,lineIndex), CTLineRef.self)
            // 4 ç‚¹å‡»çš„index
            let startIndex = CTLineGetStringIndexForPosition(clickLine, clickPoint)

            print("strIndex = \(startIndex)")
            // 5
            for range in self.spcialRanges{

                if startIndex >= range.location && startIndex <= range.location + range.length{

                    gestureShouldBegin = true
                    self.pressRange = range
                    print(range)

                }   
              }
           }
            return gestureShouldBegin
        }
    }


gestureRecognizerShouldBeginæ˜¯ä¸€ä¸ªä»£ç†æ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­æ¥æ£€æµ‹ç‰¹æ®Šå­—ç¬¦ä¸²<br>

1ã€æ‹¿åˆ°è§¦æ‘¸ç‚¹åœ¨å½“å‰viewçš„ä½ç½®<br>

2ã€æ ¹æ®yå€¼å’Œè¡Œé«˜çš„æ¯”è·å–lineç¼–å·ï¼ŒlineHeightæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ã€‚å¯ä»¥ä¸‹è½½æœ¬æ–‡å®ä¾‹ä»£ç å¯¹ç…§çœ‹<br>

3ã€è½¬æˆCoreTextä¸‹åæ ‡<br>

4ã€è·å–å­—ç¬¦çš„index<br>

5ã€å¾ªç¯ç‰¹æ®Šå­—ç¬¦çš„rangeæŸ¥çœ‹indexæ˜¯å¦åœ¨rangeä¸­ å¦‚æœåœ¨rangeä¸­ æŠŠå½“å‰æŒ‰ä¸‹çš„rangeèµ‹å€¼ä¸ºæ­¤rangeï¼Œæ‰“å°å‡ºæ¥ã€‚<br>

è¿™æ—¶å€™ åœ¨tapæ–¹æ³•ä¸­å–å‡ºè¿™ä¸ªrangeå¯¹åº”çš„å­—ç¬¦ä¸² æ‰“å°å‡ºæ¥ï¼Œå¦‚æœè¦å¤„ç†å¯¹åº”äº‹ä»¶ã€‚ä¹Ÿå¯åœ¨tapè¿™é‡Œå¤„ç†<br>

æ¥çœ‹ä¸‹<br>

![1]({{ page.path }}/blog/tuogao/tougao17/5.gif)<br>

CoreText èƒ½åšçš„ä¸æ­¢è¿™äº›å¸Œæœ›å¤§å®¶è¿™ä¸¤ç¯‡æ–‡ç« å¯ä»¥å¸¦å¤§å®¶äº†è§£CoreTextï¼Œä¸å†æƒ§æ€•ä½¿ç”¨åº•å±‚çš„APIã€‚

æœ¬æ–‡å®ä¾‹ä»£ç å·²ä¸Šä¼ github: [https://github.com/smalldu/ZZCoreTextDemo](https://github.com/smalldu/ZZCoreTextDemo)<br>


----------------------------------------------------------

> [åšä¸»appä¸Šçº¿å•¦ï¼Œå¿«ç‚¹æ­¤æ¥å›´è§‚å§](https://itunes.apple.com/us/app/it-blog-zi-xueios-kai-fa-jin/id1067787090?l=zh&ls=1&mt=8)<br>

> [æ›´å¤šç»éªŒè¯·ç‚¹å‡»](http://allluckly.cn/)<br>

å¥½æ–‡æ¨èï¼š[iOSå¼€å‘ä¹‹è¯¦è§£è¿è¿æ”¯ä»˜é›†æˆ](http://allluckly.cn/iosæ”¯ä»˜/lianlianzhifu/)<br>







