---
layout: post
title: "Swift2.0ä¹‹CoreTextæ’ç‰ˆç¥å™¨(é•¿ç¯‡é«˜èƒ½)"
description: "CoreText"
category: æŠ•ç¨¿
headline: Discover the theme elements
tags: [Swift2.0ï¼ŒCoreTextï¼Œæ’ç‰ˆï¼ŒiOSå¼€å‘]
imagefeature: BG2.jpg
comments: true
featured: 
mathjax: true
path: /images
---
ç¼–è¾‘ï¼š[Bison](http://allluckly.cn/)<br>
æŠ•ç¨¿ï¼š[å¤§çŸ³å¤´å¸ƒ](http://www.jianshu.com/p/e52a38e60e7c)<br>

>&quot;CoreTextæ˜¯ä¸€ä¸ªè¿›é˜¶çš„æ¯”è¾ƒåº•å±‚çš„å¸ƒå±€æ–‡æœ¬å’Œå¤„ç†å­—ä½“çš„æŠ€æœ¯ï¼ŒCoreText APIåœ¨OS X v10.5 å’Œ iOS3.2æ—¶å¼•å…¥ï¼Œåœ¨OS X å’ŒiOS ç¯å¢ƒä¸‹å‡å¯ä»¥ä½¿ç”¨ã€‚:&quot;

<br>

ä¸æ˜¯ç‰¹åˆ«å¤æ‚çš„éœ€æ±‚ä¸€èˆ¬æƒ…å†µä¸‹UILabelã€UITextViewéƒ½å¯ä»¥æå®šï¼Œä»–ä»¬æ˜¯Appleå¸®æˆ‘ä»¬å°è£…å¥½çš„æ˜¾ç¤ºæ–‡æœ¬çš„æ§ä»¶ï¼Œä½†æ˜¯åƒå¤æ‚çš„å›¾æ–‡ï¼Œé“¾æ¥è¯†åˆ«å¹¶æ›¿æ¢æˆ "ç‚¹å‡»é“¾æ¥" ï¼Œ @someone ç»‘å®š ï¼Œç”µè¯è¯†åˆ«ï¼Œæ–‡å­—å¤§å°ä¸ä¸€ ï¼Œå½“ç„¶è¿™äº›å¯ä»¥ä½¿ç”¨UIWebView,ä½†æ˜¯CoreText æŠ€æœ¯ç›¸å¯¹äº UIWebViewï¼Œæœ‰ç€æ›´å°‘çš„å†…å­˜å ç”¨ï¼Œä»¥åŠå¯ä»¥åœ¨åå°æ¸²æŸ“çš„ä¼˜ç‚¹ï¼Œéå¸¸é€‚åˆç”¨äºå†…å®¹çš„æ’ç‰ˆå·¥ä½œã€‚CoreText æä¾›äº†éå¸¸é«˜çš„çµæ´»æ€§ï¼Œä½†æ˜¯æ“ä½œèµ·æ¥çš„æ¯”è¾ƒå¤æ‚ï¼Œå­¦æŠ€æœ¯ä¸å°±åº”è¯¥æ‰¾æœ€éš¾çš„æ”»å…‹å—ï¼Ÿ<br>


æ¥çœ‹ä¸€å¼ æ¡†æ¶å›¾<br>

![1]({{ site.url }}/images/blog/tuogao/tougao14/1.png)<br>

è¦å­¦ä¹ CoreText é¦–å…ˆå¾—äº†è§£å±æ€§å­—---NSAttributedString æˆ–è€… NSMutableAttributedString<br>

NSAttributedString å’Œ NSMutableAttributedString<br>
NSAttributedStringæ˜¯ä¸€ä¸ªå¸¦æœ‰å±æ€§çš„å­—ç¬¦ä¸²,é€šè¿‡è¯¥ç±»å¯ä»¥çµæ´»åœ°æ“ä½œå’Œå‘ˆç°å¤šç§æ ·å¼çš„æ–‡å­—æ•°æ®<br>

å¯ä»¥äº‹å…ˆå®šä¹‰å¥½å±æ€§ ç„¶ååŠ åˆ°æ–‡å­—ä¸Š<br>

{% highlight css %}

let str = "è¿™æ˜¯ä¸€æ®µç”¨æ¥æµ‹è¯•çš„å­—ç¬¦ä¸² this is a string for test"
let dic = [NSFontAttributeName:UIFont.boldSystemFontOfSize(20),
NSForegroundColorAttributeName:UIColor.redColor()]
let attrStr = NSAttributedString(string: str, attributes: dic)
label.attributedText = attrStr

{% endhighlight %}

æ•ˆæœ<br>

![1]({{ site.url }}/images/blog/tuogao/tougao14/2.png)<br>

å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å¹¶æ²¡æœ‰ç»™labelè®¾ç½®é¢œè‰²å’Œå­—ä½“ï¼Œåˆ›å»ºäº†ä¸€ä¸ªå¸¦ä¸¤ä¸ªå±æ€§çš„NSAttributedString ï¼Œ æ²¡æœ‰ä½¿ç”¨label.textè€Œæ˜¯ label.attributedText<br>

å¦‚æœåªèƒ½ç»™æ‰€æœ‰çš„æ–‡å­—è®¾ç½®ä¸€æ ·çš„å±æ€§ï¼Œé‚£è¿™ä¸ªå±æ€§å­—ä¹Ÿå¤ªæ²¡åŠ²äº†ã€‚æˆ‘ä»¬å¯ä»¥ç»™ä¸€æ®µæ–‡å­—è®¾ç½®ä¸åŒçš„å±æ€§<br>

{% highlight css %}
let mutableAttrStr = NSMutableAttributedString(string: str)
mutableAttrStr.addAttributes(dic, range: NSMakeRange(0, 2))
mutableAttrStr.addAttributes([NSFontAttributeName:UIFont.systemFontOfSize(13),NSUnderlineStyleAttributeName: 1 ], range: NSMakeRange(2,8))
label.attributedText = mutableAttrStr
{% endhighlight %}

æˆ‘ä»¬å¯ä»¥ç»™ä¸åŒä½ç½®çš„æ–‡å­—æŒ‡å®šä¸åŒçš„æ ·å¼ï¼Œä½ç½®é€šè¿‡NSRangeç»™å‡º(NSRangeæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œæœ‰ä¸¤ä¸ªå‚æ•° ä¸€ä¸ªlocation ä¸€ä¸ª length ,è¿™ä¸¤ä¸ªå‚æ•°å¯ä»¥å”¯ä¸€çš„ç¡®å®šä¸€æ®µå­—ä¸²)<br>

æ•ˆæœ<br>

![1]({{ site.url }}/images/blog/tuogao/tougao14/3.png)<br>

è¿™æ ·æˆ‘ä»¬å°±ç»™å‰é¢çš„æ–‡å­—è®¾ç½®äº†ä¸¤ç§ä¸åŒçš„å±æ€§ã€‚<br>

é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è®¾ç½®å“ªäº›å±æ€§å‘¢ã€‚<br>

- NSFontAttributeName è®¾ç½®å­—ä½“å±æ€§ï¼Œé»˜è®¤å€¼ï¼šå­—ä½“ï¼šHelvetica(Neue) å­—å·12<br>

- NSForegroundColorAttributeName è®¾ç½®å­—ä½“é¢œè‰²ï¼Œå–å€¼ä¸º UIColorå¯¹è±¡ï¼Œé»˜è®¤å€¼ä¸º<br>

- NSBackgroundColorAttributeName è®¾ç½®å­—ä½“æ‰€åœ¨åŒºåŸŸèƒŒæ™¯é¢œè‰²ï¼Œå–å€¼ä¸º UIColorå¯¹è±¡ï¼Œé»˜è®¤å€¼ä¸ºnil, é€æ˜<br>

- NSLigatureAttributeName è®¾ç½®è¿ä½“å±æ€§ï¼Œå–å€¼ä¸ºNSNumber å¯¹è±¡(æ•´æ•°)ï¼Œ0 è¡¨ç¤ºæ²¡æœ‰è¿ä½“å­—ç¬¦ï¼Œ1 è¡¨ç¤ºä½¿ç”¨é»˜è®¤çš„è¿ä½“å­—ç¬¦<br>

- NSKernAttributeName è®¾å®šå­—ç¬¦é—´è·ï¼Œå–å€¼ä¸º NSNumber å¯¹è±¡ï¼ˆæ•´æ•°ï¼‰ï¼Œæ­£å€¼é—´è·åŠ å®½ï¼Œè´Ÿå€¼é—´è·å˜çª„<br>

- NSStrikethroughStyleAttributeName è®¾ç½®åˆ é™¤çº¿ï¼Œå–å€¼ä¸º NSNumber å¯¹è±¡ï¼ˆæ•´æ•°ï¼‰<br>

- NSStrikethroughColorAttributeName è®¾ç½®åˆ é™¤çº¿é¢œè‰²ï¼Œå–å€¼ä¸º UIColor å¯¹è±¡ï¼Œé»˜è®¤å€¼ä¸ºé»‘è‰²<br>

- NSUnderlineStyleAttributeName è®¾ç½®ä¸‹åˆ’çº¿ï¼Œå–å€¼ä¸º NSNumber å¯¹è±¡ï¼ˆæ•´æ•°ï¼‰ï¼Œæšä¸¾å¸¸é‡ NSUnderlineStyleä¸­çš„å€¼ï¼Œä¸åˆ é™¤çº¿ç±»ä¼¼NSUnderlineColorAttributeName è®¾ç½®ä¸‹åˆ’çº¿é¢œè‰²ï¼Œå–å€¼ä¸º UIColor å¯¹è±¡ï¼Œé»˜è®¤å€¼ä¸ºé»‘è‰²<br>

- NSStrokeWidthAttributeName è®¾ç½®ç¬”ç”»å®½åº¦ï¼Œå–å€¼ä¸º NSNumber å¯¹è±¡ï¼ˆæ•´æ•°ï¼‰ï¼Œè´Ÿå€¼å¡«å……æ•ˆæœï¼Œæ­£å€¼ä¸­ç©ºæ•ˆæœ<br>

- NSStrokeColorAttributeName å¡«å……éƒ¨åˆ†é¢œè‰²ï¼Œä¸æ˜¯å­—ä½“é¢œè‰²ï¼Œå–å€¼ä¸º UIColor å¯¹è±¡NSShadowAttributeName è®¾ç½®é˜´å½±å±æ€§ï¼Œå–å€¼ä¸º NSShadow å¯¹è±¡<br>

- NSTextEffectAttributeName è®¾ç½®æ–‡æœ¬ç‰¹æ®Šæ•ˆæœï¼Œå–å€¼ä¸º NSString å¯¹è±¡ï¼Œç›®å‰åªæœ‰å›¾ç‰ˆå°åˆ·æ•ˆæœå¯ç”¨ï¼š<br>

- NSBaselineOffsetAttributeName è®¾ç½®åŸºçº¿åç§»å€¼ï¼Œå–å€¼ä¸º NSNumber ï¼ˆfloatï¼‰,æ­£å€¼ä¸Šåï¼Œè´Ÿå€¼ä¸‹å<br>

- NSObliquenessAttributeName è®¾ç½®å­—å½¢å€¾æ–œåº¦ï¼Œå–å€¼ä¸º NSNumber ï¼ˆfloatï¼‰,æ­£å€¼å³å€¾ï¼Œè´Ÿå€¼å·¦å€¾<br>

- NSExpansionAttributeName è®¾ç½®æ–‡æœ¬æ¨ªå‘æ‹‰ä¼¸å±æ€§ï¼Œå–å€¼ä¸º NSNumber ï¼ˆfloatï¼‰,æ­£å€¼æ¨ªå‘æ‹‰ä¼¸æ–‡æœ¬ï¼Œè´Ÿå€¼æ¨ªå‘å‹ç¼©æ–‡æœ¬<br>

- NSWritingDirectionAttributeName è®¾ç½®æ–‡å­—ä¹¦å†™æ–¹å‘ï¼Œä»å·¦å‘å³ä¹¦å†™æˆ–è€…ä»å³å‘å·¦ä¹¦å†™<br>

- NSVerticalGlyphFormAttributeName è®¾ç½®æ–‡å­—æ’ç‰ˆæ–¹å‘ï¼Œå–å€¼ä¸º NSNumber å¯¹è±¡(æ•´æ•°)ï¼Œ0 è¡¨ç¤ºæ¨ªæ’æ–‡æœ¬ï¼Œ1 è¡¨ç¤ºç«–æ’æ–‡æœ¬<br>

- NSLinkAttributeName è®¾ç½®é“¾æ¥å±æ€§ï¼Œç‚¹å‡»åè°ƒç”¨æµè§ˆå™¨æ‰“å¼€æŒ‡å®šURLåœ°å€<br>

- NSAttachmentAttributeName è®¾ç½®æ–‡æœ¬é™„ä»¶,å–å€¼ä¸ºNSTextAttachmentå¯¹è±¡,å¸¸ç”¨äºæ–‡å­—å›¾ç‰‡æ··æ’<br>

- NSParagraphStyleAttributeName è®¾ç½®æ–‡æœ¬æ®µè½æ’ç‰ˆæ ¼å¼ï¼Œå–å€¼ä¸º NSParagraphStyle å¯¹è±¡<br>

è¿™ä¹ˆå¤šå±æ€§ä½¿ç”¨çš„ä¹Ÿè®°ä¸ä½ï¼Œä½¿ç”¨çš„æ—¶å€™è‡ªè¡Œgoogleç”¨æ³•ï¼Œè¿˜æ˜¯å¾ˆå¼ºå¤§çš„ğŸ˜„ï¼ï¼<br>

å±æ€§å­—å°±ä»‹ç»è¿™ä¹ˆå¤šï¼Œç®€å•å¯Œæ–‡æœ¬ä½¿ç”¨å®ƒå°±èƒ½æå®šã€‚ä¸‹é¢ä»‹ç»æˆ‘ä»¬çš„ä¸»è§’--CoreText<br>

###CoreText<br>

å±æ€§å­—æ˜¯ç”¨æ¥ç»™æ–‡æœ¬è®¾ç½®æ ·å¼ï¼Œé‚£ä¹ˆCoreTextå°±æ˜¯ç”¨æ¥ç»™æ–‡æœ¬è¿›è¡Œæ’ç‰ˆçš„ï¼Œå¯ä»¥è‡ªå®šæ¯è¡Œé«˜åº¦ï¼Œæ¯ä¸ªå­—ç¬¦å ä½ ç­‰ç­‰<br>

CoreText æ˜¯ç”¨äºå¤„ç†æ–‡å­—å’Œå­—ä½“çš„åº•å±‚æŠ€æœ¯ã€‚å®ƒç›´æ¥å’Œ Core Graphicsï¼ˆåˆè¢«ç§°ä¸º Quartzï¼‰æ‰“äº¤é“ã€‚Quartz æ˜¯ä¸€ä¸ª 2D å›¾å½¢æ¸²æŸ“å¼•æ“ã€‚Quartz èƒ½å¤Ÿç›´æ¥å¤„ç†å­—ä½“ï¼ˆfontï¼‰å’Œå­—å½¢ï¼ˆglyphsï¼‰ï¼Œå°†æ–‡å­—æ¸²æŸ“åˆ°ç•Œé¢ä¸Šï¼Œå®ƒæ˜¯åŸºç¡€åº“ä¸­å”¯ä¸€èƒ½å¤Ÿå¤„ç†å­—å½¢çš„æ¨¡å—ã€‚å› æ­¤ï¼ŒCoreText ä¸ºäº†æ’ç‰ˆï¼Œéœ€è¦å°†æ˜¾ç¤ºçš„æ–‡æœ¬å†…å®¹ã€ä½ç½®ã€å­—ä½“ã€å­—å½¢ç›´æ¥ä¼ é€’ç»™ Quartzã€‚ç›¸æ¯”å…¶å®ƒ UI ç»„ä»¶ï¼Œç”±äº CoreText ç›´æ¥å’Œ Quartz æ¥äº¤äº’ï¼Œæ‰€ä»¥å®ƒå…·æœ‰é«˜é€Ÿçš„æ’ç‰ˆæ•ˆæœã€‚<br>

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªCoreTextå¯¹è±¡æ¨¡å‹å›¾<br>

![1]({{ site.url }}/images/blog/tuogao/tougao14/4.png)<br>


æ¥ä¸€æ®µæ¯ç‡¥çš„è®²è§£(åé¢ä¼šæœ‰ğŸŒ°çš„)<br>

> å¦‚ä¸Šå›¾æ‰€è¿°ï¼Œå…¶ä¸­Framesetterå¯¹åº”çš„ç±»å‹æ˜¯CTFramesetterï¼Œé€šè¿‡CFAttributedString(NSAttributeString ä¹Ÿå¯ä»¥æ— ç¼æ¡¥æ¥)è¿›è¡Œåˆå§‹åŒ–ï¼Œå®ƒä½œä¸ºCTFrameå¯¹è±¡çš„ç”Ÿäº§å·¥å‚ï¼Œè´Ÿè´£æ ¹æ®pathç”Ÿäº§å¯¹åº”çš„CTFrameã€‚CTFrameæ˜¯å¯ä»¥é€šè¿‡CTFrameDrawå‡½æ•°ç›´æ¥ç»˜åˆ¶åˆ°contextä¸Šçš„ï¼Œå½“ç„¶ä½ å¯ä»¥åœ¨ç»˜åˆ¶ä¹‹å‰ï¼Œæ“ä½œCTFrameä¸­çš„CTLineï¼Œè¿›è¡Œä¸€äº›å‚æ•°çš„å¾®è°ƒã€‚CTLine å¯ä»¥çœ‹åšCore Textç»˜åˆ¶ä¸­çš„ä¸€è¡Œçš„å¯¹è±¡ é€šè¿‡å®ƒå¯ä»¥è·å¾—å½“å‰è¡Œçš„line ascent,line descent ,line leading,è¿˜å¯ä»¥è·å¾—Lineä¸‹çš„æ‰€æœ‰Glyph Runsã€‚CTRun æˆ–è€…å«åš Glyph Runï¼Œæ˜¯ä¸€ç»„å…±äº«ç›¸åŒattributesï¼ˆå±æ€§ï¼‰çš„å­—å½¢çš„é›†åˆä½“ã€‚CTFrameæ˜¯æŒ‡æ•´ä¸ªè¯¥UIViewå­æ§ä»¶çš„ç»˜åˆ¶åŒºåŸŸï¼ŒCTLineåˆ™æ˜¯æŒ‡æ¯ä¸€è¡Œï¼ŒCTRunåˆ™æ˜¯æ¯ä¸€æ®µå…·æœ‰ä¸€æ ·å±æ€§çš„å­—ç¬¦ä¸²ã€‚æ¯”å¦‚æŸæ®µå­—ä½“å¤§å°ã€é¢œè‰²éƒ½ä¸€è‡´çš„å­—ç¬¦ä¸²ä¸ºä¸€ä¸ªCTRunï¼ŒCTRunä¸å¯ä»¥è·¨è¡Œï¼Œä¸ç®¡å±æ€§ä¸€è‡´æˆ–ä¸ä¸€è‡´ã€‚é€šå¸¸çš„ç»“æ„æ˜¯æ¯ä¸€ä¸ªCTFrameæœ‰å¤šä¸ªCTLineï¼Œæ¯ä¸€ä¸ªCTLineæœ‰å¤šä¸ªCTRunã€‚<br>

ç”±äºCoreTextä¸€å¼€å§‹ä¾¿æ˜¯å®šä½äºæ¡Œé¢çš„æ’ç‰ˆç³»ç»Ÿï¼Œæ‰€ä»¥ä½¿ç”¨äº†ä¼ ç»Ÿçš„åŸç‚¹åœ¨å·¦ä¸‹è§’çš„åæ ‡ç³»ï¼Œæ‰€ä»¥å®ƒåœ¨ç»˜åˆ¶æ–‡æœ¬çš„æ—¶å€™éƒ½æ˜¯å‚ç…§å·¦ä¸‹è§’çš„åŸç‚¹è¿›è¡Œç»˜åˆ¶çš„ã€‚<br>

![1]({{ site.url }}/images/blog/tuogao/tougao14/5.png)<br>


å¦‚æœä½ å•¥ä¹Ÿä¸åšå¤„ç†ï¼Œç›´æ¥åœ¨è¿™ä¸ªcontextä¸Šè¿›è¡ŒCoreTextç»˜åˆ¶ï¼Œä½ ä¼šå‘ç°æ–‡å­—æ˜¯é•œåƒä¸”ä¸Šä¸‹é¢ å€’ã€‚

ğŸŒ°æ¥å•¦ï¼å…ˆæ¥çœ‹ä¸€ä¸ªæœ€ç®€å•çš„CoreTextä½¿ç”¨çš„ä¾‹å­

ä¸€ä¸ªç®€å•çš„ä¾‹å­
é¦–å…ˆæ–°å»ºä¸€ä¸ªCTViewç»§æ‰¿è‡ªUIView
{% highlight css %}
import UIKit

class CTView: UIView {

    override func drawRect(rect: CGRect) {
        super.drawRect(rect)

        // 1
        let context = UIGraphicsGetCurrentContext()

        // 2
        CGContextSetTextMatrix(context, CGAffineTransformIdentity)
        CGContextTranslateCTM(context, 0, self.bounds.size.height)
        CGContextScaleCTM(context, 1.0, -1.0)

        // 3
        let path = CGPathCreateMutable()
        CGPathAddRect(path, nil, self.bounds)

        // 4
        let attrString = NSAttributedString(string:"Hello CoreText!")
        let framesetter = CTFramesetterCreateWithAttributedString(attrString)
        let frame = CTFramesetterCreateFrame(framesetter, CFRangeMake(0, attrString.length), path, nil)

        // 5
        CTFrameDraw(frame,context!)
    }
}
{% endhighlight %}

ç„¶åæŠŠè¿™ä¸ªviewåŠ åœ¨ViewControllerä¸Š<br>

{% highlight css %}

let ctView = CTView()
ctView.frame = CGRectMake(10, 150, self.view.bounds.width - 20, 200)
ctView.backgroundColor = UIColor.whiteColor()
self.view.addSubview(ctView)

{% endhighlight %}

è¿è¡Œæ•ˆæœ:<br>

![1]({{ site.url }}/images/blog/tuogao/tougao14/6.png)<br>


###è§£é‡Šï¼š<br>

1ã€ é€šè¿‡UIGraphisGetCurrentContext()è·å–å½“å‰çš„ç¯å¢ƒ<br>
2ã€å°†åæ ‡ç³»ä¸Šä¸‹ç¿»è½¬ã€‚å¯¹äºåº•å±‚çš„ç»˜åˆ¶å¼•æ“æ¥è¯´ï¼Œå±å¹•çš„å·¦ä¸‹è§’æ˜¯ï¼ˆ0, 0ï¼‰åæ ‡ã€‚è€Œå¯¹äºä¸Šå±‚çš„ UIKit æ¥è¯´ï¼Œå·¦ä¸Šè§’æ˜¯ (0, 0) åæ ‡ã€‚æ‰€ä»¥æˆ‘ä»¬ä¸ºäº†ä¹‹åçš„åæ ‡ç³»æè¿°æŒ‰ UIKit æ¥åšï¼Œæ‰€ä»¥å…ˆåœ¨è¿™é‡Œåšä¸€ä¸ªåæ ‡ç³»çš„ä¸Šä¸‹ç¿»è½¬æ“ä½œã€‚ç¿»è½¬ä¹‹åï¼Œåº•å±‚å’Œä¸Šå±‚çš„ (0, 0) åæ ‡å°±æ˜¯é‡åˆçš„äº†ã€‚<br>
3ã€åˆ›å»ºç»˜åˆ¶åŒºåŸŸCGPathCreateMutable(),CoreText æœ¬èº«æ”¯æŒå„ç§æ–‡å­—æ’ç‰ˆçš„åŒºåŸŸï¼Œæˆ‘ä»¬è¿™é‡Œç®€å•åœ°å°† UIView çš„æ•´ä¸ªç•Œé¢ä½œä¸ºæ’ç‰ˆçš„åŒºåŸŸã€‚<br>

å½“ç„¶è¿™é‡Œå¦‚æœè§‰å¾—CGMutablePath ä¸å¥½ç”¨ å¯ä»¥é€‰æ‹©ä½¿ç”¨æ›´æ–¹ä¾¿çš„UIBezierPathæ¥æ“ä½œæ’ç‰ˆåŒºåŸŸ.
<br>
æŠŠä¸Šæ–‡ä¸­çš„3æ”¹æˆ<br>
{% highlight css %}

let path1 = UIBezierPath(roundedRect: self.bounds, cornerRadius:self.bounds.size.width/2 )

{% endhighlight %}

æŠŠ4æ”¹æˆ é¡ºä¾¿ç»™æ–‡å­—åŠ äº†ç‚¹å±æ€§<br>

{% highlight css %}
// 4
let attrString = "Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!"

let mutableAttrStr = NSMutableAttributedString(string: attrString)
mutableAttrStr.addAttributes([NSFontAttributeName:UIFont.systemFontOfSize(20),
NSForegroundColorAttributeName:UIColor.redColor() ], range: NSMakeRange(0, 20))
mutableAttrStr.addAttributes([NSFontAttributeName:UIFont.systemFontOfSize(13),NSUnderlineStyleAttributeName: 1 ], range: NSMakeRange(20,18))
let framesetter = CTFramesetterCreateWithAttributedString(mutableAttrStr)
let frame = CTFramesetterCreateFrame(framesetter, CFRangeMake(0, mutableAttrStr.length), path1.CGPath, nil)
{% endhighlight %}

æ’ç‰ˆåŒºåŸŸå°±å˜äº† è€Œä¸”ä½¿ç”¨äº†UIBezierPathçš„API<br>

![1]({{ site.url }}/images/blog/tuogao/tougao14/7.png)<br>


4ã€æ ¹æ®AttributedStringç”ŸæˆCTFramesetterRefï¼Œæ ¹æ®framesetterå’Œç»˜å›¾åŒºåŸŸåˆ›å»ºCTFrame<br>

5ã€ä½¿ç”¨CTFrameDrawè¿›è¡Œç»˜åˆ¶(åé¢å¤æ‚çš„å¯èƒ½ä¸ä¼šç›´æ¥ç”»frame è€Œæ˜¯é€‰æ‹©ä¸€è¡Œä¸€è¡Œçš„ç”» )<br>

å›¾æ–‡æ··æ’<br>

CoreTextå¦‚æœåªèƒ½å®šä¹‰æ–‡æœ¬ç»˜åˆ¶åŒºåŸŸï¼Œé‚£å°±å¤ªæ²¡åŠ²äº†ï¼ŒCoreTextè¿˜å¯ä»¥æ”¯æŒå›¾æ–‡æ··æ’ï¼Œæœ¬åœ°å›¾ç‰‡å’Œç½‘ç»œå›¾ç‰‡ã€‚<br>

CoreTextä»ç»˜åˆ¶çº¯æ–‡æœ¬åˆ°ç»˜åˆ¶å›¾ç‰‡ï¼Œä¾ç„¶æ˜¯ä½¿ç”¨NSAttributedStringï¼Œåªä¸è¿‡å›¾ç‰‡çš„å®ç°æ–¹å¼æ˜¯ç”¨ä¸€ä¸ªç©ºç™½å­—ç¬¦ä½œä¸ºåœ¨NSAttributedStringä¸­çš„å ä½ç¬¦ï¼Œç„¶åè®¾ç½®ä»£ç†ï¼Œå‘Šè¯‰CoreTextç»™è¯¥å ä½å­—ç¬¦ç•™å‡ºä¸€å®šçš„å®½é«˜ã€‚æœ€åæŠŠå›¾ç‰‡ç»˜åˆ¶åˆ°é¢„ç•™çš„ä½ç½®ä¸Šã€‚<br>

![1]({{ site.url }}/images/blog/tuogao/tougao14/8.png)<br>

å›¾ä¸­ ç¬¬ä¸€ä¸ªå›¾ç‰‡æ˜¯å­˜åœ¨æœ¬åœ°ï¼Œç¬¬äºŒä¸ªå›¾ç‰‡æ˜¯æ¥è‡ªç½‘ç»œã€‚ä¸‹é¢çœ‹çœ‹æ€ä¹ˆåšã€‚ä»£ç æœ‰ç‚¹é•¿ ä½†æ˜¯æ€è·¯åº”è¯¥æ¸…æ™°ã€‚<br>

{% highlight css %}
import UIKit

class CTPicTxtView: UIView {

var image:UIImage?

    override func drawRect(rect: CGRect) {
        super.drawRect(rect)

        // 1 è·å–ä¸Šä¸‹æ–‡
        let context = UIGraphicsGetCurrentContext()

        // 2 è½¬æ¢åæ ‡
        CGContextSetTextMatrix(context, CGAffineTransformIdentity)
        CGContextTranslateCTM(context, 0, self.bounds.size.height)
        CGContextScaleCTM(context, 1.0, -1.0)

        // 3 ç»˜åˆ¶åŒºåŸŸ
        let path = UIBezierPath(rect: rect)

        // 4 åˆ›å»ºéœ€è¦ç»˜åˆ¶çš„æ–‡å­—
        let attrString = "Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!Hello CoreText!"

        let mutableAttrStr = NSMutableAttributedString(string: attrString)
        mutableAttrStr.addAttributes([NSFontAttributeName:UIFont.systemFontOfSize(20),
        NSForegroundColorAttributeName:UIColor.redColor() ], range: NSMakeRange(0, 5))
        mutableAttrStr.addAttributes([NSFontAttributeName:UIFont.systemFontOfSize(13),NSUnderlineStyleAttributeName: 1 ], range: NSMakeRange(3,10))
        let style = NSMutableParagraphStyle()   //ç”¨æ¥è®¾ç½®æ®µè½æ ·å¼
        style.lineSpacing = 6 //è¡Œé—´è·
        mutableAttrStr.addAttributes([NSParagraphStyleAttributeName:style], range: NSMakeRange(0, mutableAttrStr.length))

        // 5 ä¸ºå›¾ç‰‡è®¾ç½®CTRunDelegate,delegateå†³å®šç•™ç»™å›¾ç‰‡çš„ç©ºé—´å¤§å°
        var imageName = "mc"
        var  imageCallback =  CTRunDelegateCallbacks(version: kCTRunDelegateVersion1, dealloc: { (refCon) -> Void in

        }, getAscent: { ( refCon) -> CGFloat in

            //                let imageName = "mc"
            //                refCon.initialize()
            //                let image = UIImage(named: imageName)
            return 100  //è¿”å›é«˜åº¦

        }, getDescent: { (refCon) -> CGFloat in

            return 50  //è¿”å›åº•éƒ¨è·ç¦»

        }) { (refCon) -> CGFloat in

            //                let imageName = String("mc")
            //                let image = UIImage(named: imageName)
            return 100  //è¿”å›å®½åº¦

        }
        let runDelegate  = CTRunDelegateCreate(&imageCallback, &imageName)
        let imgString = NSMutableAttributedString(string: " ")  // ç©ºæ ¼ç”¨äºç»™å›¾ç‰‡ç•™ä½ç½®
        imgString.addAttribute(kCTRunDelegateAttributeName as String, value: runDelegate!, range: NSMakeRange(0, 1))  //rundelegate  å ä¸€ä¸ªä½ç½®
        imgString.addAttribute("imageName", value: imageName, range: NSMakeRange(0, 1))//æ·»åŠ å±æ€§ï¼Œåœ¨CTRunä¸­å¯ä»¥è¯†åˆ«å‡ºè¿™ä¸ªå­—ç¬¦æ˜¯å›¾ç‰‡
        mutableAttrStr.insertAttributedString(imgString, atIndex: 15)


        //ç½‘ç»œå›¾ç‰‡ç›¸å…³
        var  imageCallback1 =  CTRunDelegateCallbacks(version: kCTRunDelegateVersion1, dealloc: { (refCon) -> Void in

        }, getAscent: { ( refCon) -> CGFloat in
            return 70  //è¿”å›é«˜åº¦

        }, getDescent: { (refCon) -> CGFloat in

            return 50  //è¿”å›åº•éƒ¨è·ç¦»

        }) { (refCon) -> CGFloat in
            return 100  //è¿”å›å®½åº¦

        }
        var imageUrl = "http://img3.3lian.com/2013/c2/64/d/65.jpg" //ç½‘ç»œå›¾ç‰‡é“¾æ¥
        let urlRunDelegate  = CTRunDelegateCreate(&imageCallback1, &imageUrl)
        let imgUrlString = NSMutableAttributedString(string: " ")  // ç©ºæ ¼ç”¨äºç»™å›¾ç‰‡ç•™ä½ç½®
        imgUrlString.addAttribute(kCTRunDelegateAttributeName as String, value: urlRunDelegate!, range: NSMakeRange(0, 1))  //rundelegate  å ä¸€ä¸ªä½ç½®
        imgUrlString.addAttribute("urlImageName", value: imageUrl, range: NSMakeRange(0, 1))//æ·»åŠ å±æ€§ï¼Œåœ¨CTRunä¸­å¯ä»¥è¯†åˆ«å‡ºè¿™ä¸ªå­—ç¬¦æ˜¯å›¾ç‰‡
        mutableAttrStr.insertAttributedString(imgUrlString, atIndex: 50)


        // 6 ç”Ÿæˆframesetter
        let framesetter = CTFramesetterCreateWithAttributedString(mutableAttrStr)
        let frame = CTFramesetterCreateFrame(framesetter, CFRangeMake(0, mutableAttrStr.length), path.CGPath, nil)

        // 7 ç»˜åˆ¶é™¤å›¾ç‰‡ä»¥å¤–çš„éƒ¨åˆ†
        CTFrameDraw(frame,context!)

        // 8 å¤„ç†ç»˜åˆ¶å›¾ç‰‡é€»è¾‘
        let lines = CTFrameGetLines(frame) as NSArray //å­˜å–frameä¸­çš„ctlines


        let ctLinesArray = lines as Array
        var originsArray = [CGPoint](count:ctLinesArray.count, repeatedValue: CGPointZero)
        let range: CFRange = CFRangeMake(0, 0)
        CTFrameGetLineOrigins(frame,range,&originsArray)

        //éå†CTRunæ‰¾å‡ºå›¾ç‰‡æ‰€åœ¨çš„CTRunå¹¶è¿›è¡Œç»˜åˆ¶,æ¯ä¸€è¡Œå¯èƒ½æœ‰å¤šä¸ª
        for i in 0..<lines.count{
            //éå†æ¯ä¸€è¡ŒCTLine
            let line = lines[i]
            var lineAscent = CGFloat()
            var lineDescent = CGFloat()
            var lineLeading = CGFloat()
            //è¯¥å‡½æ•°é™¤äº†ä¼šè®¾ç½®å¥½ascent,descent,leadingä¹‹å¤–ï¼Œè¿˜ä¼šè¿”å›è¿™è¡Œçš„å®½åº¦
            CTLineGetTypographicBounds(line as! CTLineRef, &lineAscent, &lineDescent, &lineLeading)

            let runs = CTLineGetGlyphRuns(line as! CTLine) as NSArray
            for j in 0..<runs.count{
            // éå†æ¯ä¸€ä¸ªCTRun
            var  runAscent = CGFloat()
            var  runDescent = CGFloat()
            let  lineOrigin = originsArray[i]// è·å–è¯¥è¡Œçš„åˆå§‹åæ ‡
            let run = runs[j] // è·å–å½“å‰çš„CTRun
            let attributes = CTRunGetAttributes(run as! CTRun) as NSDictionary

            let width =  CGFloat( CTRunGetTypographicBounds(run as! CTRun, CFRangeMake(0,0), &runAscent, &runDescent, nil))

            let  runRect = CGRectMake(lineOrigin.x + CTLineGetOffsetForStringIndex(line as! CTLine, CTRunGetStringRange(run as! CTRun).location, nil), lineOrigin.y - runDescent, width, runAscent + runDescent)
            let imageNames = attributes.objectForKey("imageName")
            let urlImageName = attributes.objectForKey("urlImageName")

            if imageNames is NSString {
                //æœ¬åœ°å›¾ç‰‡
                let image = UIImage(named: imageName as String)
                let imageDrawRect = CGRectMake(runRect.origin.x, lineOrigin.y-runDescent, 100, 100)
                CGContextDrawImage(context, imageDrawRect, image?.CGImage)
            }

            if let urlImageName = urlImageName as? String{
                var image:UIImage?
                let imageDrawRect = CGRectMake(runRect.origin.x, lineOrigin.y-runDescent, 100, 100)
                if self.image == nil{
                image = UIImage(named:"hs") //ç°è‰²å›¾ç‰‡å ä½
                //å»ä¸‹è½½
                if let url = NSURL(string: urlImageName){
                    let request = NSURLRequest(URL: url)
                    NSURLSession.sharedSession().dataTaskWithRequest(request, completionHandler: { (data, resp, err) -> Void in

                    if let data = data{
                        dispatch_sync(dispatch_get_main_queue(), { () -> Void in
                        self.image = UIImage(data: data)
                        self.setNeedsDisplay()  //ä¸‹è½½å®Œæˆä¼šé‡ç»˜
                        })

                    }
                }).resume()
                }

             }else{
                image = self.image
             }
            CGContextDrawImage(context, imageDrawRect, image?.CGImage)
          }
         }
        }

    }

}

{% endhighlight %}

<br>

1ã€2ã€3ã€4å’Œå‰é¢ç®€å•Demoæ˜¯ä¸€æ¨¡ä¸€æ ·çš„ ï¼Œåªæ˜¯åŠ äº†ä¸ªè¡Œé—´è·ã€‚<br>

5ã€ è¿™å—ç”¨ä¸€ä¸ªå›è°ƒè®¾ç½®äº†å›¾ç‰‡å¤§å°ç­‰ä¿¡æ¯ ï¼Œç„¶ä¼šåˆ›å»ºäº†ä¸€ä¸ªCTRunçš„ä»£ç†ï¼Œåˆ›å»ºä¸€ä¸ªç©ºç™½å ä½å­—ç¬¦ï¼Œç»™å®ƒåŠ äº†ä¸ªå±æ€§ï¼Œåé¢ç»˜åˆ¶çš„æ—¶å€™å¥½è¯†åˆ«ã€‚ æœ€åæŠŠè¿™ä¸ªå ä½ç¬¦åŠ åˆ°æˆ‘ä»¬å±æ€§æ–‡æœ¬çš„æŸä¸ªä½ç½®ã€‚<br>

åœ°ä¸‹ç½‘ç»œå›¾ç‰‡ nameæ¢æˆäº†url å…¶ä»–å¦‚æ³•ç‚®åˆ¶<br>

6ã€7å’Œä¸Šå°ç»“ä¸€æ ·çš„<br>

8ã€ æ­£å¼å¼€å§‹å¤„ç†å›¾ç‰‡éƒ¨åˆ†<br>

æ ¹æ®CTFrame è·å– CTLine è·å– originsArray æ¯ä¸€è¡Œçš„åŸç‚¹ï¼Œç”¨æ¥å®šä½ ã€‚æ ¹æ®CTLineè·å–åˆ° CTRun ã€‚ CTRunæ˜¯æ¯ä¸€ä¸ªç›¸åŒå±æ€§å­—ç¬¦ä¸² ï¼Œä½†æ˜¯ä¸ä¼šéš”è¡Œã€‚<br>

éå†CTRun æ ¹æ®æˆ‘ä»¬å‰é¢è®¾ç½®çš„å±æ€§ æ‰¾åˆ°æœ¬åœ°å›¾ç‰‡è¿›è¡Œç»˜åˆ¶<br>

ç½‘ç»œå›¾ç‰‡çš„ç»˜åˆ¶ä¹Ÿå¾ˆç®€å•å¦‚æœæ²¡æœ‰ä¸‹è½½ å…ˆæ”¾ä¸ªç°è‰²çš„å›¾å ä½ï¼Œç„¶åå»ä¸‹è½½ï¼Œä¸‹è½½å¥½äº† èµ‹å€¼ç»™selfçš„ä¸€ä¸ªå˜é‡ ï¼Œç„¶åé‡ç»˜å°±OKäº† å…³äºNSURLSessionä¸ä¼šä½¿ç”¨çš„å¯ä»¥çœ‹æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« ã€‚[NSURLSession](http://allluckly.cn/æŠ•ç¨¿/tuogao10)<br>

å…³äºCoreTextè¿˜æœ‰å¾ˆå¤šï¼Œé€è¡Œæ’ç‰ˆ æ–‡å­—å’Œemoji æ··æ’é—®é¢˜ ï¼Œ è¿æ¥è¯†åˆ« ï¼Œç‚¹å‡»å›¾ç‰‡ ç‚¹å‡»è¿æ¥ç­‰ç­‰ã€‚ã€‚ç¯‡å¹…æœ‰ç‚¹é•¿ã€‚ã€‚ä¸‹ä¸€ç¯‡æ¥ç€ä»‹ç»ï¼Œè¿™ç¯‡å…ˆåˆ°è¿™è¾¹ã€‚<br>

æœ¬æ–‡å®ä¾‹ä»£ç å·²ä¸Šä¼ github: [https://github.com/smalldu/ZZCoreTextDemo](https://github.com/smalldu/ZZCoreTextDemo)<br>


----------------------------------------------------------

> [åšä¸»appä¸Šçº¿å•¦ï¼Œå¿«ç‚¹æ­¤æ¥å›´è§‚å§](https://itunes.apple.com/us/app/it-blog-zi-xueios-kai-fa-jin/id1067787090?l=zh&ls=1&mt=8)<br>

> [æ›´å¤šç»éªŒè¯·ç‚¹å‡»](http://allluckly.cn/)<br>

å¥½æ–‡æ¨èï¼š[iOSå¼€å‘ä¹‹è¯¦è§£è¿è¿æ”¯ä»˜é›†æˆ](http://allluckly.cn/iosæ”¯ä»˜/lianlianzhifu)<br>







