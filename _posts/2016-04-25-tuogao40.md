---
layout: post
title: "Swiftä¹‹ä¼˜åŒ–UITableViewCellé«˜åº¦è®¡ç®—"
description: "Swift"
category: æŠ•ç¨¿
headline: Discover the theme elements
tags: [Swiftä¼˜åŒ–UITableViewï¼Œé«˜åº¦è®¡ç®—ï¼ŒiOSå¼€å‘]
imagefeature: 
comments: true
featured: 
mathjax: true
path: /images
---

>&quot;æœ€è¿‘åœ¨æƒ³ç€æ€ä¹ˆæé«˜è‡ªå·±çš„iOSæŠ€èƒ½ï¼Œä¸æ–­çš„é˜…è¯»åˆ«äººçš„blogã€‚å‘ç°è¯»å®Œäº†ä¸ç»ƒæ‰‹å¾ˆå¿«åˆå¿˜æ‰äº†ï¼Œç»ƒæ‰‹å§åˆä¸çŸ¥é“ä»ä½•å¤„ä¸‹æ‰‹ã€‚æ‰€ä»¥å°±æƒ³ç€çœ‹çœ‹åˆ«äººå†™çš„åº“æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œä½“é‡æ¯”è¾ƒå¤§çš„çœ‹èµ·æ¥å¾ˆè´¹åŠ²ï¼Œå½±å“å£«æ°”ã€‚é‚£å°±ä»ä½“é‡æ¯”è¾ƒå°çš„çœ‹èµ·ã€‚&quot;

ç¼–è¾‘ï¼š[Bison](http://allluckly.cn/)<br>
æŠ•ç¨¿ï¼š[å¤§çŸ³å¤´å¸ƒ](http://www.jianshu.com/p/c4a5fc3a4cd3)<br>



UITableViewåº”è¯¥æ˜¯iOSéå¸¸å¸¸ç”¨çš„ä¸€ä¸ªç»„ä»¶ï¼Œå­¦è¿‡iOSéƒ½ä¼šç”¨ï¼Œä½†æ˜¯ç”¨å¥½å®ƒå´å¹¶ä¸æ˜¯é‚£ä¹ˆeasy ã€‚ä¸æ°å½“çš„ä½¿ç”¨å¾€å¾€ä¼šé€ æˆæ‰å¸§å¼•èµ·ç•Œé¢å¡é¡¿ã€‚

å…³äºç•Œé¢ä¸Šå›¾åƒçš„æ˜¾ç¤ºåŸç†ï¼Œå¡é¡¿é€ æˆçš„åŸå› ä¹‹ç±»çš„å¯ä»¥çœ‹è¿™ç¯‡ï¼Œ[iOS ä¿æŒç•Œé¢æµç•…çš„æŠ€å·§](http://blog.ibireme.com/2015/11/12/smooth_user_interfaces_for_ios/) , YYå¤§ç¥æ˜¯ç”¨å¼‚æ­¥æ¸²æŸ“çš„æŠ€æœ¯ä½¿ç•Œé¢æµç¨‹ï¼Œç›®å‰è¿˜çœ‹ä¸æ‡‚ã€‚ã€‚ğŸ˜‚ï¼Œä½†æ˜¯é‚£äº›æˆåƒå’Œå¡é¡¿çš„åŸç†è¿˜æ˜¯å€¼å¾—å¥½å¥½çœ‹çœ‹çš„ã€‚

å¦‚æœä½ æ˜¯å› ä¸ºåœ†è§’é˜´å½±å¤ªå¤šç­‰é—®é¢˜å¼•èµ·çš„ï¼Œå¯ä»¥çœ‹[iOS é«˜æ•ˆæ·»åŠ åœ†è§’æ•ˆæœå®æˆ˜è®²è§£](http://www.jianshu.com/p/f970872fdc22) ã€‚

ä¸Šé¢éƒ½ä¸æ˜¯é‡ç‚¹ï¼Œé‡ç‚¹æ˜¯ç”±äºç³»ç»Ÿä¼šå¤šæ¬¡é‡å¤è®¡ç®—TableviewCellçš„é«˜åº¦

å…³äºUITableViewCellæ€æ ·è®¾ç½®é«˜åº¦ä»¥åŠå¯¹æ€§èƒ½å½±å“çš„è¯¦ç»†æè¿°è¯·ç›´æ¥æˆ³ [ä¼˜åŒ–UITableViewCellé«˜åº¦è®¡ç®—çš„é‚£äº›äº‹](http://blog.sunnyxx.com/2015/05/17/cell-height-calculation/)

ä¸Šé¢é‚£ä¸ªæ–‡ç« ä¸€å®šè¦è¯»ï¼Œæ˜¯ç™¾åº¦å¤§ç¥sunnyxx å†™çš„(è™½ç„¶ç°åœ¨å·²ç»ç¦»å¼€ç™¾åº¦äº†)ã€‚å¤§ç¥è¯¦ç»†è®²è¿°äº†UITableViewCellè®¡ç®—çš„å„ç§æ–¹å¼ä»¥åŠä¼šæœ‰å“ªäº›æ€§èƒ½é—®é¢˜ï¼Œå¹¶ä¸”å†™äº†ä¸€ä¸ªå¼€æºåº“è§£å†³äº†é—®é¢˜ï¼Œæé«˜äº†UITableViewæ»‘åŠ¨çš„æµç•…æ€§ã€‚å¼€æºåº“åœ°å€ï¼š[UITableView+FDTemplateLayoutCell](https://github.com/forkingdog/UITableView-FDTemplateLayoutCell)ï¼Œä½œè€…å†™é‚£ç¯‡æ–‡ç« çš„æ—¶å€™é‚£ä¸ªåº“çš„ç‰ˆæœ¬æ˜¯1.2ï¼Œç°åœ¨å·²ç»1.5äº†ã€‚

æœ¬æ–‡å¸¦å¤§å®¶è¯¦ç»†æ¢ç´¢é‚£ç¯‡æ–‡ç« æ‰€å¯¹åº”çš„åº“(1.2ç‰ˆ)ã€‚å¹¶å®ç°ä¸€ä¸ªswiftç‰ˆæœ¬çš„åº“ã€‚(é€‰æ‹©ä»–ä¸»è¦æ˜¯å› ä¸ºç®€çŸ­ï¼Œä¹Ÿå°è¯•å»çœ‹è¿‡YYå¤§ç¥çš„åº“ï¼Œå„ç§çœ‹ä¸æ‡‚æœ€ååªå¥½å…ˆæç½®äº†ã€‚ã€‚)

> æœ‰äº›äººä¼šé—®ï¼Œåˆ«äººå·²ç»æœ‰äº†ä¸ºå•¥è¿˜è¦å†å®ç°ä¸€éï¼ŒOCå’ŒSwiftä¸æ˜¯å¯ä»¥æ¡¥æ¥ä¹ˆç›´æ¥ç”¨å°±è¡Œäº†ã€‚æˆ‘æƒ³è¯´ç”¨swiftå®ç°ä¸»è¦æ˜¯æƒ³ç†è§£ä½œè€…çš„æ¯è¡Œä»£ç çš„å«ä¹‰ï¼Œä½œè€…çš„æ€æƒ³ï¼Œä»¥åŠå¯¹åº”swiftä¸­çš„å®ç°æ–¹å¼ã€‚ï¼ˆOCå’Œswiftè¿˜æ˜¯æœ‰æŒºå¤šåŒºåˆ«çš„ï¼‰ï¼Œç†è§£äº†åº“çš„æ¯è¡Œä»£ç ï¼Œè‡ªå·±ä½¿ç”¨ä¹Ÿæ”¾å¿ƒï¼Œè‡ªå·±å®ç°äº†ä¸€ä¸ªä»¥åæœ‰ä»€ä¹ˆåˆ«çš„éœ€æ±‚è‡ªå·±ç›´æ¥å¯ä»¥æ”¹è‡ªå·±è¿™ç‰ˆä»£ç ï¼ŒæŒæ¡äº†ä»–çš„æ€æƒ³ï¼Œå¯ä»¥ç±»æ¯”å†™å‡ºåˆ«çš„æ¯”è¾ƒå¥½ç”¨çš„åº“ã€‚ï¼ˆä¸€ä¸¾å¤šå¾— è¿˜ä¸å¥½å¥½çœ‹æºç ?ï¼‰<br>

è¿™ä¸ªåº“èƒ½å¹²å•¥ ï¼Œå°±æ˜¯åˆ©ç”¨ç¼“å­˜tableviewcellçš„é«˜åº¦æé«˜æ»‘åŠ¨çš„æµç•…æ€§ï¼Œæˆ‘ç”¨äº† sunnyxx åŸæœ‰çš„æ•°æ®ï¼Œæ·»åŠ äº†å¾ˆå¤šemojè¡¨æƒ…åœ¨è‡ªå·±å®ç°çš„swiftç‰ˆä¸Šåšäº†æµ‹è¯• ã€‚ï¼ˆä¸åŠ å¾ˆå¤šemojï¼Œç®€çŸ­çš„æ–‡å­—ç¼“å­˜å’Œä¸ç¼“å­˜åŸºæœ¬éƒ½æ²¡ç§’60å¸§æ²¡å•¥åŒºåˆ«ï¼‰

ç»“æœæ˜¯ç¼“å­˜çš„åŸºæœ¬åœ¨æ¯ç§’50å¤šå¸§ ï¼Œæ²¡ç¼“å­˜çš„ä¼šæ‰åˆ°äºŒåå‡ ç”šè‡³åå‡ å¸§ ã€‚ï¼ˆ
YYå¤§ç¥çš„å¼‚æ­¥æ¸²æŸ“ä¼°è®¡å¯ä»¥ä¿æŒåœ¨60å¸§ ï¼‰

ä¸‹é¢æ”¾ä¸¤å‰¯æˆªå›¾ï¼šï¼ˆæµ‹è¯•å¿…é¡»åœ¨çœŸæœºä¸Šè¿è¡Œï¼Œæ¨¡æ‹Ÿå™¨ä¸Šæ²¡æœ‰GPUï¼Œæ˜¯CPUæ¨¡æ‹Ÿçš„ éƒ½ä¼šæ‰å¸§çœ‹ä¸åˆ°æ•ˆæœï¼‰

æ²¡æœ‰ç¼“å­˜æ‹–åŠ¨è¿‡ç¨‹æˆªå›¾<br>
![1]({{ site.url }}/images/blog/tuogao/tougao40/1.jpg)<br>

ç¼“å­˜åæ‹–åŠ¨è¿‡ç¨‹æˆªå›¾<br>
![1]({{ site.url }}/images/blog/tuogao/tougao40/2.jpg)<br>


é‚£ä¸ªFPSæ˜¯è‡ªå·±å†™çš„ä¸€ä¸ªviewåˆ©ç”¨CADisplayLink å®ç°çš„ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥çœ‹æºç ï¼Œæ¨¡ä»¿YYå¤§ç¥åº“ä¸­çš„ä¸€ä¸ªç±»ã€‚

ç•Œé¢ç»˜åˆ¶å¤§é‡emojçš„æ—¶å€™ä¸€èˆ¬éƒ½ä¼šæœ‰å¡é¡¿ï¼Œå°¤å…¶é€‚ç”¨autolayout æ¯æ¬¡è®¡ç®—ï¼Œæˆ‘ä»¬ç¼“å­˜äº†cellé«˜åº¦åå¯ä»¥ç¼“è§£è¿™æ ·çš„é—®é¢˜ã€‚

ä¸‹é¢æ¥è¿›å…¥æ­£é¢˜ï¼Œçœ‹ä¸‹å®ç°æ€è·¯ï¼Œå…¶å®å¦‚æœä½ çœ‹äº†è¿™ç¯‡æ–‡ç« ï¼Œä½ å·²ç»çŸ¥é“äº†å®ç°æ€è·¯[ä¼˜åŒ–UITableViewCellé«˜åº¦è®¡ç®—çš„é‚£äº›äº‹](http://blog.sunnyxx.com/2015/05/17/cell-height-calculation/)

ä¸»è¦æ˜¯åˆ©ç”¨Runloopåœ¨ç©ºé—²çŠ¶æ€ä¸‹åå°è®¡ç®—tableviewcellçš„é«˜åº¦å¹¶ç¼“å­˜èµ·æ¥ã€‚ç„¶ååœ¨ä½¿ç”¨çš„æ—¶å€™å°±ç›´æ¥ä»ç¼“å­˜ä¸­å»ï¼Œè¿™é‡Œéƒ½æ”¾åœ¨ä¸€ä¸ªæ•°ç»„é‡Œå­˜åœ¨å†…å­˜ã€‚

å¯¹Runloopä»¥åŠå‡ ä¸ªmodeä¸æ‡‚çš„å¯ä»¥çœ‹sunnyxx blogä¸­çš„è§†é¢‘ [è§†é¢‘å¯æˆ³](http://yun.baidu.com/share/link?shareid=2268593032&uk=2885973690) ï¼Œ æ–‡ç« çš„è¯å¯ä»¥çœ‹çœ‹ [æ·±å…¥ç†è§£RunLoop](http://blog.ibireme.com/2015/05/18/runloop/) ã€ [ã€iOSç¨‹åºå¯åŠ¨ä¸è¿è½¬ã€‘- RunLoopä¸ªäººå°ç»“](http://www.jianshu.com/p/37ab0397fec7)

å¦‚æœä½ è€ç€æ€§å­æŠŠä¸Šé¢çš„è¿æ¥éƒ½çœ‹äº†ï¼Œä½ å†çœ‹sunnyxx blogä¸­çš„è§£é‡Šåº”è¯¥å°±ä¸ä¼šæ™•äº†ã€‚å…¶å®å°±æ˜¯åœ¨kCFRunLoopDefaultModeæ¨¡å¼ä¸‹BeforWaittingçŠ¶æ€å»æ‰§è¡Œè®¡ç®—çš„ã€‚

ä¸‹é¢æ¥æ¢ç©¶æºç ã€‚é¦–å…ˆåœ¨[UITableView+FDTemplateLayoutCell](https://github.com/forkingdog/UITableView-FDTemplateLayoutCell) ä¸‹è½½æºç ï¼Œä¸‹è½½1.2ç‰ˆæœ¬ã€‚ 1.5ç‰ˆæœ¬æ²¡æœ‰ç”¨Runloopå®ç°ã€‚

ç„¶åä½ å¾—åˆ°çš„åº“å°±ä¸¤ä¸ªæ–‡ä»¶ ï¼ˆåœ¨swiftä¸­å°±åªæœ‰ä¸€ä¸ªå•¦ï¼‰ã€‚

![1]({{ site.url }}/images/blog/tuogao/tougao40/3.png)<br>

å¤§æ¦‚çœ‹äº†ä¸‹ï¼Œ.mæ–‡ä»¶åªæœ‰500è¡Œã€‚<br>

PSï¼šåªè¦è·Ÿç€çœ‹ï¼Œè‚¯å®šå¯ä»¥çœ‹æ‡‚ï¼Œåé¢è¿˜æœ‰å¾ˆå¤šå¹²è´§<br>

çœ‹ä¸‹ä½œè€…çš„å®ç°æ€è·¯ï¼šï¼ˆä»ä¸Šå¾€ä¸‹çœ‹ï¼‰<br>
1ã€ åˆ›å»ºäº†ä¸€ä¸ª_FDTemplateLayoutCellHeightCacheç±»ï¼Œå°±æ˜¯ç®¡ç†Cacheçš„ä¸€ä¸ªç±»ï¼Œé‡Œé¢æœ‰ä¸¤ä¸ªå±æ€§å››ä¸ªæ–¹æ³•ã€‚<br>

### å±æ€§ï¼š<br>
sections è¿™ä¸ªå˜é‡å°±æ˜¯ç”¨æ¥å­˜å‚¨ç¼“å­˜çš„heightçš„ä¸€ä¸ªäºŒç»´æ•°ç»„ã€‚ï¼ˆå› ä¸ºtableviewæœ‰sectionå’Œrowç»„æˆæ‰€ä»¥å¿…é¡»äºŒç»´ï¼‰<br>

    _FDTemplateLayoutCellHeightCacheAbsentValue è¿™ä¸ªæ˜¯ä¸€ä¸ªé™æ€å¸¸é‡ï¼Œå°±æ˜¯ç”¨æ¥æ ‡è®°æ²¡æœ‰ç¼“å­˜é«˜åº¦row ã€‚
<br>

### æ–¹æ³•ï¼š<br>

<br>

    buildHeightCachesAtIndexPathsIfNeeded:indexPaths

<br>
è¿™ä¸ªæ–¹æ³•ä¼ å…¥indexPathsæ•°ç»„æ¥ç»™sectionsä¸­è¿˜æ²¡æœ‰åˆå§‹åŒ–çš„å…ƒç´ è¿›è¡Œåˆå§‹åŒ–
hasCachedHeightAtIndexPath:indexPath æ ¹æ®ä¸‹æ ‡ç´¢å¼•åˆ¤æ–­æ˜¯å¦æœ‰ç¼“å­˜ï¼ˆå…¶å®å°±æ˜¯åˆ¤æ–­æ˜¯å¦ç­‰äºä¸Šé¢é‚£ä¸ªé™æ€å¸¸é‡ï¼‰
cacheHeight:height:byIndexPath æ ¹æ®indexPathç»™sectionsèµ‹å€¼ã€‚
cachedHeightAtIndexPath:indexPath æ ¹æ®indexPathå–å€¼
è¿™ä¸ªç±»ä¸»è¦æ“ä½œå’Œå­˜å‚¨ç¼“å­˜çš„ã€‚çœ‹çœ‹swiftä¸­çš„å®ç°æ–¹æ³•ã€‚<br>

    class ZZTemplateLayoutCellHeightCache:NSObject,NSCopying{

        var sections:[[CGFloat]] = []

        func copyWithZone(zone: NSZone) -> AnyObject {
            let theCopy = ZZTemplateLayoutCellHeightCache()
            theCopy.sections = self.sections
            return theCopy
        }

        // æ ‡è®°æ²¡æœ‰è¢«cacheçš„å€¼
        static let ZZTemplateLayoutCellHeightCacheAbsentValue:CGFloat = -1

        /**
         åˆå§‹åŒ–Heightç¼“å­˜æ•°ç»„ å¯¹æ¯ä¸ªå…ƒç´ åšæ ‡è®°

         - parameter indexPaths: indexPathsæ•°ç»„
         */
        func buildHeightCachesAtIndexPathsIfNeeded(indexPaths:[NSIndexPath]){
            guard indexPaths.count > 0 else { return }
            indexPaths.forEach { (indexPath) -> () in
                //å¦‚æœsection æ•°ç»„é‡Œé¢è¿˜æ²¡æœ‰ åˆ›å»ºä¸€ä¸ªå¯¹è±¡çš„ç©ºæ•°ç»„
                if indexPath.section >= self.sections.count{
                    self.sections.insert([], atIndex: indexPath.section)
                }

                var rows = self.sections[indexPath.section]
                //å¦‚æœå¯¹åº”çš„rowä¸å­˜åœ¨ åˆ›å»ºä¸€ä¸ªå¹¶æ ‡è®°ä¸ºæ²¡æœ‰è¢«cache
                if indexPath.row >= rows.count {
                    rows.insert(ZZTemplateLayoutCellHeightCache.ZZTemplateLayoutCellHeightCacheAbsentValue, atIndex: indexPath.row)
                }
                self.sections[indexPath.section] = rows
            }

        }

        /**
         indexPathæ˜¯å¦å·²ç»è¢«ç¼“å­˜

         - parameter indexPath: indexPath

         - returns: Bool
         */
        func hasCachedHeightAtIndexPath(indexPath:NSIndexPath)->Bool{

            self.buildHeightCachesAtIndexPathsIfNeeded([indexPath])
            return self.sections[indexPath.section][indexPath.row] != ZZTemplateLayoutCellHeightCache.ZZTemplateLayoutCellHeightCacheAbsentValue

        }

        /**
         ç¼“å­˜é«˜åº¦

         - parameter height:    é«˜åº¦
         - parameter indexPath: indexPathç´¢å¼•
         */
        func cacheHeight(height:CGFloat,byIndexPath indexPath:NSIndexPath){

            self.buildHeightCachesAtIndexPathsIfNeeded([indexPath])
            self.sections[indexPath.section][indexPath.row] = height

        }

        /**
         è·å–å·²ç»ç¼“å­˜çš„height

         - parameter indexPath: indexPathç´¢å¼•

         - returns: height
         */
        func cachedHeightAtIndexPath(indexPath:NSIndexPath)->CGFloat{
            self.buildHeightCachesAtIndexPathsIfNeeded([indexPath])
            return self.sections[indexPath.section][indexPath.row]
        }
    }

<br>
æ¯”ä»–å¤šå†™äº†ä¸ªcopyWithZone: ç”±äºè¦èµ‹å€¼éœ€è¦å®ç°NSCopyingåè®®ã€‚<br>

æ¥ç€å¾€ä¸‹çœ‹ï¼Œä»–å†™äº†ä¸ªUITableViewçš„æ‰©å±•<br>

![1]({{ site.url }}/images/blog/tuogao/tougao40/4.png)<br>

çœ‹ç¬¬ä¸€ä¸ªæ–¹æ³•<br>

![1]({{ site.url }}/images/blog/tuogao/tougao40/5.png)<br>

è¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯é€šè¿‡ä½ ä¼ å…¥çš„ä¸€ä¸ªidentifier(å°±æ˜¯å¤ç”¨çš„id)è·å–cell

ç¬¬ä¸€å¥æ˜¯è¿™æ ·çš„<br>

    NSMutableDictionary *templateCellsByIdentifiers = objc_getAssociatedObject(self, _cmd);

<br>
OCä¸­çš„ _cmd ä»£è¡¨çš„å°±æ˜¯æœ¬æ–¹æ³•ï¼Œobjc_getAssociatedObject è·å–ä¸€ä¸ªå…³è”å¯¹è±¡çš„å±æ€§ï¼Œå…¶å®åœ¨swiftä¸­ æˆ‘ä»¬å¯ä»¥ç›´æ¥ç»™ç³»ç»Ÿå·²æœ‰çš„ç±»æ·»åŠ å±æ€§<br>

æ¯”å¦‚è¿™ä¸ªæ–¹æ³•ä¸­çš„cellè¿˜æœ‰ä¸ªå±æ€§ fd_isTemplateLayoutCell æˆ‘ä»¬å®ç°ä¸€ä¸ªswiftç‰ˆçš„<br>

    extension UITableViewCell{
        //åœ¨ç§æœ‰åµŒå¥— struct ä¸­ä½¿ç”¨ static varï¼Œè¿™æ ·ä¼šç”Ÿæˆæˆ‘ä»¬æ‰€éœ€çš„å…³è”å¯¹è±¡é”®ï¼Œä½†ä¸ä¼šæ±¡æŸ“æ•´ä¸ªå‘½åç©ºé—´ã€‚
        private struct AssociatedKeys{
            static var zz_isTemplateLayoutCell = "zz_isTemplateLayoutCell"
        }

        ///æ‰©å±• æ·»åŠ å±æ€§ æ˜¯å¦ä¸ºä¸´æ—¶å¸ƒå±€çš„cell
        var zz_isTemplateLayoutCell:Bool? {
            set{
                objc_setAssociatedObject(self, &AssociatedKeys.zz_isTemplateLayoutCell,newValue, objc_AssociationPolicy.OBJC_ASSOCIATION_COPY_NONATOMIC)
            }
            get{
                return objc_getAssociatedObject(self, &AssociatedKeys.zz_isTemplateLayoutCell) as? Bool
            }
        }
    }

å‚è€ƒè¿™ç¯‡æ–‡ç«  [Swift & the Objective-C Runtime](http://nshipster.cn/swift-objc-runtime/)<br>
æ›´å¤šRuntimeçŸ¥è¯†æ‰©å±•é˜…è¯»ï¼š[Objective-C Runtime](http://yulingtianxia.com/blog/2014/11/05/objective-c-runtime/)<br>
[Objective-C Runtime 1å°æ—¶å…¥é—¨æ•™ç¨‹](http://yulingtianxia.com/blog/2014/11/05/objective-c-runtime/)<br>

æ‡‚äº†è¿™äº›ä¸œè¥¿ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠä»–æ‰€æœ‰ç”¨_cmdå’ŒOCç‰ˆæœ¬è¹©è„šçš„å±æ€§åŠ ä¸Šå»ï¼Œç”¨æˆ‘ä»¬æ¯”è¾ƒä¼˜ç¾çš„æ–¹å¼ã€‚<br>

    extension UITableView{

        private struct AssociatedKeys{
            static var zz_debugLogEnabled = "zz_debugLogEnabled"
            static var zz_chc = "zz_chc"
            static var zz_tmpCellForReuseId = "zz_tmpCellForReuseId"
            static var zz_autoCacheInvalidationEnabled = "zz_autoCacheInvalidationEnabled"
            static var zz_precacheEnabled = "zz_precacheEnabled"
        }

        /// æ‰©å±• æ·»åŠ å±æ€§ æ˜¯å¦åœ¨debugçš„æƒ…å†µä¸‹æ‰“å°
        var zz_debugLogEnabled:Bool? {
            set{
                objc_setAssociatedObject(self, &AssociatedKeys.zz_debugLogEnabled,newValue, objc_AssociationPolicy.OBJC_ASSOCIATION_COPY_NONATOMIC)
            }
            get{
                return objc_getAssociatedObject(self, &AssociatedKeys.zz_debugLogEnabled) as? Bool
            }
        }


        private var zz_chc:ZZTemplateLayoutCellHeightCache?{
            set{
                objc_setAssociatedObject(self, &AssociatedKeys.zz_chc,newValue, objc_AssociationPolicy.OBJC_ASSOCIATION_COPY_NONATOMIC)
            }
            get{
                return objc_getAssociatedObject(self, &AssociatedKeys.zz_chc) as? ZZTemplateLayoutCellHeightCache
            }
        }

        private var zz_tmpCellForReuseId:[String:UITableViewCell]?{
            set{
                objc_setAssociatedObject(self, &AssociatedKeys.zz_tmpCellForReuseId,newValue, objc_AssociationPolicy.OBJC_ASSOCIATION_COPY_NONATOMIC)
            }
            get{
                return objc_getAssociatedObject(self, &AssociatedKeys.zz_tmpCellForReuseId) as? [String:UITableViewCell]
            }
        }

        var zz_autoCacheInvalidationEnabled:Bool?{
            set{
                objc_setAssociatedObject(self, &AssociatedKeys.zz_autoCacheInvalidationEnabled,newValue, objc_AssociationPolicy.OBJC_ASSOCIATION_COPY_NONATOMIC)
            }
            get{
                return objc_getAssociatedObject(self, &AssociatedKeys.zz_autoCacheInvalidationEnabled) as? Bool
            }
        }

        var zz_precacheEnabled:Bool?{
            set{
                objc_setAssociatedObject(self, &AssociatedKeys.zz_precacheEnabled,newValue, objc_AssociationPolicy.OBJC_ASSOCIATION_COPY_NONATOMIC)
            }
            get{
                return objc_getAssociatedObject(self, &AssociatedKeys.zz_precacheEnabled) as? Bool
            }
        }
    }

<br>
ç„¶åé‚£ä¸ªé€šè¿‡idè·å–cellçš„æ–¹æ³•åœ¨swiftä¸­çš„å®ç°å°±æ²¡é‚£ä¹ˆé•¿äº†ï¼Œå¾ˆç®€çŸ­çš„ã€‚<br>

     /**
         æ ¹æ®identifierè·å–UITableViewCell

         - parameter identifier: identifier

         - returns: UITableViewCell
         */
        func zz_templateCellForReuseIdentifier(identifier:String)->UITableViewCell{
            assert(identifier.characters.count>0, "éœ€è¦ä¸€ä¸ªæ­£ç¡®çš„identifier - \(identifier)")

            if zz_tmpCellForReuseId == nil {
                zz_tmpCellForReuseId = [:]
            }
            var templateCell = zz_tmpCellForReuseId![identifier]
            if templateCell == nil{

                templateCell = self.dequeueReusableCellWithIdentifier(identifier)
                assert(templateCell != nil, "cellå¿…é¡»å·²ç»ç”¨identifieræ³¨å†Œè¿‡: - \(identifier)")
                templateCell!.zz_isTemplateLayoutCell = true
                zz_tmpCellForReuseId![identifier] = templateCell
                self.zz_debugLog("cellå¸ƒå±€å·²ç»åˆ›å»º: - \(identifier)")
            }

            return templateCell!
        }

<br>
æˆ‘ä»¬åœ¨ä½¿ç”¨è¿™ä¸ªåº“çš„æ—¶å€™å›ä¼ å…¥identifier ï¼Œ åº“é‡Œé¢çš„é€šè¿‡è¿™ä¸ªæ–¹æ³•æ¥è·å–cellã€‚<br>

ç„¶åä»–æä¾›äº†ä¸€ä¸ªæ–¹æ³•ç”¨æ¥è·å–ä¸Šé¢ç®¡ç†Cacheçš„_FDTemplateLayoutCellHeightCacheçš„å¯¹è±¡ ã€‚
fd_cellHeightCache

ç”±äºæˆ‘ä»¬ç»™ä»–ä¹Ÿæ·»åŠ äº†å±æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™ä¸ªæ–¹æ³•ä¹Ÿå¼‚å¸¸çš„ç®€å•<br>

    /**
         è¿”å›ZZTemplateLayoutCellHeightCacheçš„ä¸€ä¸ªå®ä¾‹å¯¹è±¡ å¦‚æœå·²ç»å­˜åœ¨ç›´æ¥è·å–

         - returns: ZZTemplateLayoutCellHeightCacheå¯¹è±¡
         */
        func zz_cellHeightCache()->ZZTemplateLayoutCellHeightCache{
            if zz_chc == nil{
                zz_chc = ZZTemplateLayoutCellHeightCache()
            }
            return self.zz_chc!
        }

<br>
æ¥ä¸‹æ¥å°±æ˜¯ä»–å†™çš„å‡ ä¸ªå±æ€§ï¼Œæˆ‘ä»¬ä¸Šé¢ç”¨ä¼˜ç¾çš„æ–¹å¼å†™è¿‡äº†ï¼Œå¯ä»¥æ— è§†<br>

ä¸‹é¢åˆæ˜¯ä¸€ä¸ªåˆ†ç±»ï¼Œï¼ˆè¿™ä¸ªæ˜¯é‡ç‚¹è®¡ç®—é«˜åº¦ï¼Œè°ƒç”¨ç¼“å­˜ç®¡ç†æ–¹æ³•çš„åˆ†ç±»ï¼‰<br>

![1]({{ site.url }}/images/blog/tuogao/tougao40/6.png)<br>


è¿™ä¸ªé‡Œé¢çš„æ–¹æ³•åœ¨ä»–blogä¸­ä¹Ÿæœ‰æåˆ°å°±æ˜¯åœ¨NSDefaultRunLoopModeä¸‹å½“çŠ¶æ€å°†è¦è¿›å…¥ä¼‘çœ çš„æ—¶å€™æŠŠè®¡ç®—æ–¹æ³•åˆ†è§£æˆå¤šä¸ªRunLoop Sourceä»»åŠ¡ï¼ˆsource0ï¼‰<br>

    - (void)performSelector:(SEL)aSelector onThread:(NSThread *)thr withObject:(id)arg waitUntilDone:(BOOL)wait modes:(NSArray *)array;

<br>
è¿™ä¸ªæ–¹æ³•å°†åˆ›å»ºä¸€ä¸ª Source 0 ä»»åŠ¡ï¼Œåˆ†å‘åˆ°æŒ‡å®šçº¿ç¨‹çš„ RunLoop ä¸­ï¼Œåœ¨ç»™å®šçš„ Mode ä¸‹æ‰§è¡Œï¼Œè‹¥æŒ‡å®šçš„ RunLoop å¤„äºä¼‘çœ çŠ¶æ€ï¼Œåˆ™å”¤é†’å®ƒå¤„ç†äº‹ä»¶.<br>

ä¸‹é¢æ¥çœ‹çœ‹swiftä¸­çš„å®ç°ï¼›<br>

    // MARK: - cellçš„é¢„ç¼“å­˜
    extension UITableView{

        private func zz_precacheIfNeeded(){

            if let pe = self.zz_precacheEnabled where !pe {
                return
            }
            guard let delegate = self.delegate else { return }

            if !delegate.respondsToSelector(Selector("tableView:heightForRowAtIndexPath:")){
                return
            }

            let runLoop = CFRunLoopGetCurrent()
            //ä¸€ä¸ªç©ºé—²çš„Runloop ï¼Œå½“é¡µé¢æ»šåŠ¨æ—¶ä¼šåˆ‡æ¢åˆ°"UITrackingRunLoopMode"
            let runLoopMode = kCFRunLoopDefaultMode

            // æ”¶é›†æ‰€æœ‰è¢«ç¼“å­˜è¿‡çš„index paths
            var mutableIndexPathsToBePrecached = self.zz_allIndexPathsToBePrecached()

            let observer = CFRunLoopObserverCreateWithHandler(kCFAllocatorDefault, CFRunLoopActivity.BeforeWaiting.rawValue, true, 0) { (observer, _) -> Void in
                // æ‰€æœ‰é¢„ç¼“å­˜ä»»åŠ¡å®Œæˆçš„æ—¶å€™ ç§»é™¤Observer
                if mutableIndexPathsToBePrecached.count == 0{
                    CFRunLoopRemoveObserver(runLoop, observer, runLoopMode)
                    return
                }

                // å–å‡ºç¬¬ä¸€ä¸ªindexPathä½œä¸ºæ­¤Runloopè¿­ä»£çš„ä»»åŠ¡
                let indexPath = mutableIndexPathsToBePrecached.first
                mutableIndexPathsToBePrecached.removeFirst()
    //            è¿™ä¸ªæ–¹æ³•å°†åˆ›å»ºä¸€ä¸ª Source 0 ä»»åŠ¡ï¼Œåˆ†å‘åˆ°æŒ‡å®šçº¿ç¨‹çš„ RunLoop ä¸­ï¼Œåœ¨ç»™å®šçš„ Mode ä¸‹æ‰§è¡Œï¼Œè‹¥æŒ‡å®šçš„ RunLoop å¤„äºä¼‘çœ çŠ¶æ€ï¼Œåˆ™å”¤é†’å®ƒå¤„ç†äº‹ä»¶
                self.performSelector("zz_precacheIndexPathIfNeeded:", onThread: NSThread.mainThread(), withObject: indexPath, waitUntilDone: false, modes: [NSDefaultRunLoopMode])
            }

            CFRunLoopAddObserver(runLoop, observer, runLoopMode)

        }


        /**
         å¦‚æœæ²¡æœ‰ç¼“å­˜çš„è¯ å°±ç¼“å­˜é«˜åº¦

         - parameter indexPath: indexpath
         */
        func zz_precacheIndexPathIfNeeded(indexPath:NSIndexPath){
            guard let delegate = self.delegate else { return }
            if !self.zz_cellHeightCache().hasCachedHeightAtIndexPath(indexPath){
                let height = delegate.tableView!(self, heightForRowAtIndexPath: indexPath)
                self.zz_cellHeightCache().cacheHeight(height, byIndexPath: indexPath)
                self.zz_debugLog("Precached - \(indexPath.section) , \(indexPath.row) , \(height)")
            }
        }

        /**
         è·å–æ‰€æœ‰éœ€è¦è¢«ç¼“å­˜çš„indexPath

         - returns: [indexpath]
         */
        func zz_allIndexPathsToBePrecached()->[NSIndexPath]{

            var allIndexPaths:[NSIndexPath] = []
            for section in 0..<self.numberOfSections{
                for row in 0..<self.numberOfRowsInSection(section){

                    print("section is :\(section) , row is :\(row) ")
                    let indexPath = NSIndexPath(forRow: row, inSection: section)
                    if !self.zz_cellHeightCache().hasCachedHeightAtIndexPath(indexPath){
                        allIndexPaths.append(indexPath)
                    }

                }
            }
            return allIndexPaths
        }

    }

<br>
æ³¨é‡Šå¾ˆæ¸…æ¥šï¼Œä¸»è¦é€»è¾‘å°±æ˜¯å…ˆé€šè¿‡éå†æ‰€æœ‰sectionå’Œrowæ‰¾åˆ°è¿˜æ²¡æœ‰ç¼“å­˜çš„rowï¼Œç„¶ååŠ å…¥åˆ°å¾…ç¼“å­˜æ•°ç»„ ï¼Œåˆ›å»ºä¸€ä¸ªobserverå»ç›‘å¬Runloopçš„çŠ¶æ€ ï¼Œå¦‚æœç©ºé—²äº†å»åˆ›å»ºsource0ä»»åŠ¡ï¼Œæ‰§è¡Œè®¡ç®—æ–¹æ³•å¹¶ç¼“å­˜èµ·æ¥ã€‚å¦‚æœé¢„ç¼“å­˜ä»»åŠ¡å®Œæˆäº†å°±æŠŠç›‘å¬çš„Observerç§»é™¤äº†ã€‚ï¼ˆè¯´çš„æŒºæ¸…æ¥šäº†ï¼Œæœ‰å•¥é—®é¢˜å¯ä»¥è®¨è®ºï¼‰

ä¸‹é¢åˆæ˜¯ä¸€ä¸ªæ‰©å±•<br>

![1]({{ site.url }}/images/blog/tuogao/tougao40/7.png)<br>

è¿™ä¸ªåˆ†ç±»çœ‹èµ·æ¥æ¯”è¾ƒé•¿ï¼Œå…¶å®ä¹Ÿæ˜¯ä¸ªçº¸è€è™ã€‚ï¼ˆå¤§å¤šæ•°éƒ½æ˜¯åŒç†çš„ä»£ç ï¼‰

å› ä¸ºæˆ‘ä»¬ä¼šæœ‰ä¸€äº›æ“ä½œå¯¼è‡´cellçš„æ”¹å˜ï¼Œæ‰€ä»¥è¿™é‡Œä½œè€…è¦ä¿è¯åœ¨æ¯æ¬¡cellæ”¹å˜çš„æ—¶å€™æŠŠsectionsæ•°ç»„æ”¹æ‰ï¼Œç„¶åå¦‚æœæ–°å¢æˆ–è€…ä¿®æ”¹äº† éœ€è¦é‡æ–°è®¡ç®—é«˜åº¦ã€‚ç”¨åˆ°äº†methodSwizzle é»‘é­”æ³•ï¼Œç´¢æ€§æˆ‘å‰é¢æåˆ°çš„blogä¹Ÿç»™å‡ºäº†swiftä¸­æ–¹æ³•æ›¿æ¢çš„å®ç°æ–¹æ³•ã€‚

è¿™é‡Œä½œè€…æŠŠswizzleæ”¾åœ¨äº†UITableViewçš„loadç±»æ–¹æ³•ä¸­ï¼Œåœ¨swiftä¸­æˆ‘ä»¬éœ€è¦é‡å†™initialize

æ‰€ä»¥è¿™é‡Œçš„å®ç°æ–¹å¼å¦‚ä¸‹ï¼š<br>

        /**
          ç›¸å½“äº ocä¸­çš„loadç±»æ–¹æ³• åœ¨æ–¹æ³•åŠ è½½çš„ç¬¬ä¸€æ—¶é—´æ‰§è¡Œ
         */
        public override class func initialize() {

            // æ‰€æœ‰æœ‰å¯èƒ½è¦ä¿®æ”¹heightç¼“å­˜çš„æ–¹æ³•
            let selectors = [
                                Selector("reloadData"),
                                Selector("insertSections:withRowAnimation:"),
                                Selector("deleteSections:withRowAnimation:"),
                                Selector("reloadSections:withRowAnimation:"),
                                Selector("moveSection:toSection:"),
                                Selector("insertRowsAtIndexPaths:withRowAnimation:"),
                                Selector("deleteRowsAtIndexPaths:withRowAnimation:"),
                                Selector("reloadRowsAtIndexPaths:withRowAnimation:"),
                                Selector("moveRowAtIndexPath:toIndexPath:")
                            ]

            // å¯¹æ‰€æœ‰methodè½¬æ¢æˆæˆ‘ä»¬è‡ªå·±å†™çš„method
            for index in 0..<selectors.count{

                let originalSelector = selectors[index]
                let swizzledSelector = NSSelectorFromString("zz_\(NSStringFromSelector(originalSelector))")

                let originalMethod = class_getInstanceMethod(self, originalSelector)
                let swizzledMethod = class_getInstanceMethod(self, swizzledSelector)

                let didAddMethod = class_addMethod(self, originalSelector, method_getImplementation(swizzledMethod), method_getTypeEncoding(swizzledMethod))

                if didAddMethod {
                    class_replaceMethod(self, swizzledSelector, method_getImplementation(originalMethod), method_getTypeEncoding(originalMethod))
                } else {
                    method_exchangeImplementations(originalMethod, swizzledMethod);
                }

            }

        }

<br>
æŠŠæ‰€æœ‰å¯èƒ½æ”¹å˜indexPathçš„æ–¹æ³•æŠ“å‡ºæ¥ ç„¶åéå†æ›¿æ¢æ‰ ã€‚ ä¸‹é¢å°±å†™ä¸Šè‡ªå·±çš„æ–¹æ³•<br>

        func zz_reloadData(){
            if let zz_auto = self.zz_autoCacheInvalidationEnabled where zz_auto{
                self.zz_cellHeightCache().sections.removeAll()
            }
            self.zz_reloadData()
            self.zz_precacheIfNeeded()
        }

        func zz_insertSections(sections: NSIndexSet, withRowAnimation animation: UITableViewRowAnimation){
            if let zz_auto = self.zz_autoCacheInvalidationEnabled where zz_auto {
                sections.forEach({ (index) -> () in
                    self.zz_cellHeightCache().sections.insert([], atIndex: index)
                })
            }

            self.zz_insertSections(sections, withRowAnimation: animation)
            self.zz_precacheIfNeeded()
        }

        func zz_deleteSections(sections: NSIndexSet, withRowAnimation animation: UITableViewRowAnimation){

            if let zz_auto = self.zz_autoCacheInvalidationEnabled where zz_auto {
                sections.forEach({ (index) -> () in
                    self.zz_cellHeightCache().sections.removeAtIndex(index)
                })
            }
            self.zz_deleteSections(sections, withRowAnimation: animation)
        }

<br>
è¿™é‡Œå°±æ”¾äº†ä¸‰åˆ†æ–¹æ³•ä¾‹å­ï¼Œå…¶ä»–çš„çœ‹æºç ï¼Œåœ°å€åœ¨æ–‡å°¾ã€‚<br>

è²Œä¼¼ä¸€åˆ‡éƒ½å‡†å¤‡çš„å·®ä¸å¤šäº†ï¼Œä¸‹é¢å°±æ˜¯ç•™ç»™å¤–ç•Œä½¿ç”¨è€…è°ƒç”¨çš„æ–¹æ³•äº†<br>

    // MARK: - [Public] æä¾›ç»™å¤–éƒ¨çš„æ–¹æ³•
    extension UITableView{
        /**
         è®¡ç®—è·å¾—height

         - parameter identifier:    id
         - parameter configuration: configuration

         - returns: height
         */
        func zz_heightForCellWithIdentifier(identifier:String,configuration:((cell:UITableViewCell)->())?)->CGFloat{
            // é€šè¿‡idè·å–ä¸€ä¸ªcell
            let cell = self.zz_templateCellForReuseIdentifier(identifier)
            //æ‰‹åŠ¨è°ƒç”¨å·²ç¡®ä¿å’Œå±å¹•ä¸Šæ˜¾ç¤ºçš„ä¿æŒä¸€è‡´
            cell.prepareForReuse()
            configuration?(cell: cell)

            //æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ªçº¦æŸ ç¡®ä¿åŠ¨æ€å†…å®¹ å¦‚label
            let tempWidthConstraint = NSLayoutConstraint(item: cell.contentView,
                attribute: NSLayoutAttribute.Width,
                relatedBy: NSLayoutRelation.Equal,
                toItem: nil,
                attribute: NSLayoutAttribute.NotAnAttribute,
                multiplier: 1.0,
                constant: CGRectGetWidth(self.frame))

            cell.contentView.addConstraint(tempWidthConstraint)

            // ç®—å‡ºsize
            let fittingSize = cell.contentView.systemLayoutSizeFittingSize(UILayoutFittingCompressedSize)
            // ç§»é™¤çº¦æŸ
            cell.contentView.removeConstraint(tempWidthConstraint)

            return fittingSize.height
        }

        /**
         ä¾›å¤–ç•Œä½¿ç”¨çš„æ–¹æ³• æä¾›äº†é«˜åº¦çš„ç¼“å­˜

         - parameter identifier:    identifier
         - parameter indexPath:     indexPath
         - parameter configuration: ä¾›å¤–éƒ¨ä½¿ç”¨çš„é—­åŒ…
         - returns: Height
         */
        func zz_heightForCellWithIdentifier(identifier:String,cacheByIndexPath indexPath:NSIndexPath,configuration:((cell:UITableViewCell)->())?)->CGFloat{

            if self.zz_autoCacheInvalidationEnabled == nil{
                self.zz_autoCacheInvalidationEnabled = true
            }

            if self.zz_precacheEnabled == nil{
                self.zz_precacheEnabled = true
            }
            print("cache : \(indexPath.section) , \(indexPath.row)")
            // å¦‚æœå­˜åœ¨ç¼“å­˜ ä»ç¼“å­˜ä¸­è¿”å›
            if self.zz_cellHeightCache().hasCachedHeightAtIndexPath(indexPath){
                self.zz_debugLog("cache : \(indexPath.section) , \(indexPath.row) , \(self.zz_cellHeightCache().cachedHeightAtIndexPath(indexPath))")
                return self.zz_cellHeightCache().cachedHeightAtIndexPath(indexPath)
            }

            //è®¡ç®— 
            let height = self.zz_heightForCellWithIdentifier(identifier, configuration: configuration)

            self.zz_debugLog("è®¡ç®—å‡ºçš„cache cache : \(indexPath.section) , \(indexPath.row) , \(height)")

            //ç¼“å­˜
            self.zz_cellHeightCache().cacheHeight(height, byIndexPath: indexPath)

            return height
        }

    }

<br>
ç¬¬ä¸€ä¸ªæ–¹æ³•æ˜¯æ‰‹åŠ¨è®¡ç®—ç„¶åç¼“å­˜ï¼Œç¬¬äºŒä¸ªæ–¹æ³•æ˜¯å…ˆä»ç¼“å­˜ä¸­å–ï¼Œå¦‚æœæ²¡æœ‰å†è°ƒæ‰‹åŠ¨è®¡ç®—çš„æ–¹æ³•ã€‚<br>

ç„¶åå¤–ç•Œä½¿ç”¨çš„æ—¶å€™åªéœ€è¦è¿™æ ·å°±å·²ç»ç»™tableviewè®¡ç®—heightåŠ ä¸Šäº†ç¼“å­˜<br>

     func tableView(tableView: UITableView, heightForRowAtIndexPath indexPath: NSIndexPath) -> CGFloat {

            return tableView.zz_heightForCellWithIdentifier(String(ZZFeedCell), cacheByIndexPath: indexPath, configuration: { (cell) -> () in
                guard let cell = cell as? ZZFeedCell else { return }
                cell.entity = self.feedEntitySections[indexPath.section][indexPath.row]
            })

        }

<br>
æ€»ç®—è¯»å®Œäº†ä¸€ä¸ªåº“ï¼Œè™½ç„¶å°ï¼Œä½†æ˜¯æ˜¯ä¸€ä¸ªå¥½çš„å¼€ç«¯ã€‚<br>

çœ‹æºç ï¼Œçœ‹æºç ã€‚åœ°å€ï¼š[githubåœ°å€](https://github.com/smalldu/ZZTableViewTemplateLayoutCell-Swift)<br>

æœ‰ä»€ä¹ˆé—®é¢˜åœ¨åº•ä¸‹äº¤æµã€‚æ•ˆæœå›¾ä¸Šé¢å·²ç»æ”¾å‡ºï¼Œå¤§å®¶å¯ä»¥ä¸‹è½½githubä¸Šçš„æºç ï¼Œåœ¨çœŸæœºä¸Šè¿è¡Œï¼Œå¦‚æœswifté¡¹ç›®ä¸­æœ‰æƒ³ä½¿ç”¨çš„åªéœ€è¦æŠŠä¸‹å›¾ä¸­æ–‡ä»¶copyåˆ°ä½ çš„é¡¹ç›®ä¸­å°±å¯ä»¥äº†<br>

![1]({{ site.url }}/images/blog/tuogao/tougao40/8.png)<br>


----------------------------------------------------------

> [è‡ªå­¦iOSå¼€å‘è¿›é˜¶é¦–é€‰appæ¨è](https://itunes.apple.com/us/app/it-blog-zi-xueios-kai-fa-jin/id1067787090?l=zh&ls=1&mt=8)<br>

> [æ›´å¤šç»éªŒè¯·ç‚¹å‡»](http://allluckly.cn)<br>

å¥½æ–‡æ¨èï¼š[iOSå¼€å‘ä¹‹AES+Base64æ•°æ®æ··åˆåŠ å¯†ä¸è§£å¯†](http://allluckly.cn/aes/AES)<br>



